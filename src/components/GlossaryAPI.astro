---
// é‡‘èæœ¯è¯­APIç®¡ç†ç»„ä»¶
interface Props {
  showDebug?: boolean;
}

const { showDebug = false } = Astro.props;
---

<div class="glossary-api-manager">
  <h3>ğŸ”— é‡‘èæœ¯è¯­APIç®¡ç†</h3>
  
  <div class="api-status">
    <div class="status-item">
      <span class="status-label">Wikipedia API:</span>
      <span class="status-value" id="wikipedia-status">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">Investopedia:</span>
      <span class="status-value" id="investopedia-status">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">ç¼“å­˜çŠ¶æ€:</span>
      <span class="status-value" id="cache-status">æ£€æµ‹ä¸­...</span>
    </div>
  </div>
  
  <div class="api-test">
    <h4>ğŸ§ª APIæµ‹è¯•</h4>
    <div class="test-input">
      <input type="text" id="test-term" placeholder="è¾“å…¥è¦æµ‹è¯•çš„é‡‘èæœ¯è¯­" />
      <button id="test-wikipedia">æµ‹è¯•Wikipedia</button>
      <button id="test-investopedia">æµ‹è¯•Investopedia</button>
      <button id="test-all">æµ‹è¯•æ‰€æœ‰API</button>
    </div>
    <div class="test-result" id="test-result"></div>
  </div>
  
  {showDebug && (
    <div class="debug-info">
      <h4>ğŸ› è°ƒè¯•ä¿¡æ¯</h4>
      <div class="debug-content" id="debug-content"></div>
      <button id="clear-cache">æ¸…ç†ç¼“å­˜</button>
      <button id="refresh-stats">åˆ·æ–°ç»Ÿè®¡</button>
    </div>
  )}
</div>

<style>
  .glossary-api-manager {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
  }

  .glossary-api-manager h3 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
  }

  .api-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 4px;
  }

  .status-label {
    font-weight: 500;
    color: var(--text-primary);
  }

  .status-value {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
  }

  .status-value.online {
    background: #10b981;
    color: white;
  }

  .status-value.offline {
    background: #ef4444;
    color: white;
  }

  .status-value.loading {
    background: #f59e0b;
    color: white;
  }

  .api-test {
    margin-bottom: 1.5rem;
  }

  .api-test h4 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
  }

  .test-input {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .test-input input {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .test-input button {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }

  .test-input button:hover {
    background: var(--primary-dark);
  }

  .test-input button:disabled {
    background: var(--border-color);
    cursor: not-allowed;
  }

  .test-result {
    min-height: 100px;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    border: 1px solid var(--border-color);
    font-family: monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    overflow-x: auto;
  }

  .debug-info {
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
  }

  .debug-info h4 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
  }

  .debug-content {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.75rem;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 1rem;
  }

  .debug-info button {
    margin-right: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    background: var(--border-color);
    color: var(--text-primary);
    cursor: pointer;
  }

  .debug-info button:hover {
    background: var(--text-secondary);
  }

  /* æš—è‰²æ¨¡å¼é€‚é… */
  [data-theme="dark"] .glossary-api-manager {
    background: #1f2937;
    border-color: #374151;
  }

  [data-theme="dark"] .status-item {
    background: #374151;
  }

  [data-theme="dark"] .test-result,
  [data-theme="dark"] .debug-content {
    background: #374151;
    border-color: #4b5563;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .test-input {
      flex-direction: column;
    }
    
    .test-input input {
      min-width: auto;
    }
  }
</style>

<script>
  import { 
    getWikipediaTerm, 
    getInvestopediaTerm, 
    getCacheStats, 
    clearExpiredCache 
  } from '../utils/finance-glossary.js';

  // APIçŠ¶æ€æ£€æµ‹
  async function checkAPIStatus() {
    // æ£€æµ‹Wikipedia API
    try {
      const wikiResult = await getWikipediaTerm('CAGR');
      document.getElementById('wikipedia-status').textContent = 'åœ¨çº¿';
      document.getElementById('wikipedia-status').className = 'status-value online';
    } catch (error) {
      document.getElementById('wikipedia-status').textContent = 'ç¦»çº¿';
      document.getElementById('wikipedia-status').className = 'status-value offline';
    }

    // æ£€æµ‹Investopedia
    try {
      const investopediaResult = await getInvestopediaTerm('CAGR');
      document.getElementById('investopedia-status').textContent = 'åœ¨çº¿';
      document.getElementById('investopedia-status').className = 'status-value online';
    } catch (error) {
      document.getElementById('investopedia-status').textContent = 'ç¦»çº¿';
      document.getElementById('investopedia-status').className = 'status-value offline';
    }

    // æ›´æ–°ç¼“å­˜çŠ¶æ€
    updateCacheStatus();
  }

  // æ›´æ–°ç¼“å­˜çŠ¶æ€
  function updateCacheStatus() {
    const stats = getCacheStats();
    const statusText = `${stats.valid}æœ‰æ•ˆ/${stats.expired}è¿‡æœŸ (æ€»è®¡:${stats.total})`;
    document.getElementById('cache-status').textContent = statusText;
    document.getElementById('cache-status').className = 'status-value online';
  }

  // æµ‹è¯•API
  async function testAPI(apiType, term) {
    const resultDiv = document.getElementById('test-result');
    resultDiv.textContent = `æ­£åœ¨æµ‹è¯• ${apiType} API...`;
    
    try {
      let result;
      if (apiType === 'Wikipedia') {
        result = await getWikipediaTerm(term);
      } else if (apiType === 'Investopedia') {
        result = await getInvestopediaTerm(term);
      } else if (apiType === 'All') {
        const [wikiResult, investopediaResult] = await Promise.allSettled([
          getWikipediaTerm(term),
          getInvestopediaTerm(term)
        ]);
        result = {
          Wikipedia: wikiResult.status === 'fulfilled' ? wikiResult.value : null,
          Investopedia: investopediaResult.status === 'fulfilled' ? investopediaResult.value : null
        };
      }
      
      resultDiv.textContent = JSON.stringify(result, null, 2);
    } catch (error) {
      resultDiv.textContent = `é”™è¯¯: ${error.message}`;
    }
  }

  // æ›´æ–°è°ƒè¯•ä¿¡æ¯
  function updateDebugInfo() {
    const debugDiv = document.getElementById('debug-content');
    if (!debugDiv) return;
    
    const stats = getCacheStats();
    const debugInfo = {
      cacheStats: stats,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      cacheKeys: Array.from(stats.sources.keys())
    };
    
    debugDiv.textContent = JSON.stringify(debugInfo, null, 2);
  }

  // äº‹ä»¶ç›‘å¬å™¨
  document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–çŠ¶æ€æ£€æµ‹
    checkAPIStatus();
    
    // æµ‹è¯•æŒ‰é’®äº‹ä»¶
    document.getElementById('test-wikipedia')?.addEventListener('click', function() {
      const term = document.getElementById('test-term').value || 'CAGR';
      testAPI('Wikipedia', term);
    });
    
    document.getElementById('test-investopedia')?.addEventListener('click', function() {
      const term = document.getElementById('test-term').value || 'CAGR';
      testAPI('Investopedia', term);
    });
    
    document.getElementById('test-all')?.addEventListener('click', function() {
      const term = document.getElementById('test-term').value || 'CAGR';
      testAPI('All', term);
    });
    
    // è°ƒè¯•æŒ‰é’®äº‹ä»¶
    document.getElementById('clear-cache')?.addEventListener('click', function() {
      const cleared = clearExpiredCache();
      updateCacheStatus();
      updateDebugInfo();
      alert(`å·²æ¸…ç† ${cleared} ä¸ªè¿‡æœŸç¼“å­˜é¡¹`);
    });
    
    document.getElementById('refresh-stats')?.addEventListener('click', function() {
      updateCacheStatus();
      updateDebugInfo();
    });
    
    // åˆå§‹åŒ–è°ƒè¯•ä¿¡æ¯
    updateDebugInfo();
  });
</script> 
 