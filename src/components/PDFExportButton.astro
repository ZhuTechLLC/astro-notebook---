---
// PDFå¯¼å‡ºæŒ‰é’®ç»„ä»¶ï¼Œæ”¯æŒå¤šç§å¯¼å‡ºé€‰é¡¹
---

<div class="pdf-export-dropdown">
  <button id="pdfExportBtn" class="pdf-export-btn" title="å¯¼å‡ºPDF">
    ğŸ“„ PDF
    <span class="pdf-dropdown-arrow">â–¼</span>
  </button>
  
  <div id="pdfExportMenu" class="pdf-export-menu">
    <div class="pdf-export-option" data-type="current-page">
      <div class="pdf-option-icon">ğŸ“„</div>
      <div class="pdf-option-content">
        <div class="pdf-option-title">å½“å‰é¡µé¢</div>
        <div class="pdf-option-desc">å¯¼å‡ºå½“å‰é¡µé¢å†…å®¹</div>
      </div>
    </div>
    
    <div class="pdf-export-option" data-type="current-chapter">
      <div class="pdf-option-icon">ğŸ“‘</div>
      <div class="pdf-option-content">
        <div class="pdf-option-title">å½“å‰ç« èŠ‚</div>
        <div class="pdf-option-desc">å¯¼å‡ºæ•´ä¸ªç« èŠ‚å†…å®¹</div>
      </div>
    </div>
    
    <div class="pdf-export-option" data-type="full-book">
      <div class="pdf-option-icon">ğŸ“š</div>
      <div class="pdf-option-content">
        <div class="pdf-option-title">å®Œæ•´æ‰‹å†Œ</div>
        <div class="pdf-option-desc">å¯¼å‡ºæ•´å†Œæ‰‹å†Œ</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ç§»é™¤ pdfExporter ä¾èµ–ï¼Œåç»­æ‰¹é‡å¯¼å‡ºå°†æ”¹ç”±æœåŠ¡å™¨è„šæœ¬å®Œæˆ
  
  class PDFExportController {
    constructor() {
      this.init();
    }
    
    init() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.bindEvents());
      } else {
        this.bindEvents();
      }
    }
    
    bindEvents() {
      const exportBtn = document.getElementById('pdfExportBtn') as HTMLButtonElement;
      const exportMenu = document.getElementById('pdfExportMenu') as HTMLElement;
      const exportOptions = document.querySelectorAll('.pdf-export-option') as NodeListOf<HTMLElement>;
      
      if (!exportBtn || !exportMenu) {
        console.error('PDFå¯¼å‡ºæŒ‰é’®æˆ–èœå•æœªæ‰¾åˆ°');
        return;
      }
      
      // ç‚¹å‡»æŒ‰é’®æ˜¾ç¤º/éšè—èœå•
      exportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleMenu();
      });
      
      // ç‚¹å‡»é€‰é¡¹æ‰§è¡Œå¯¼å‡º
      exportOptions.forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const exportType = option.dataset.type;
          if (exportType) {
            this.handleExport(exportType);
            this.hideMenu();
          }
        });
      });
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
      document.addEventListener('click', () => {
        this.hideMenu();
      });
      
      // é˜»æ­¢èœå•å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
      exportMenu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
    
    toggleMenu() {
      const exportMenu = document.getElementById('pdfExportMenu') as HTMLElement;
      const exportBtn = document.getElementById('pdfExportBtn') as HTMLElement;
      
      if (exportMenu && exportBtn) {
        if (exportMenu.classList.contains('active')) {
          this.hideMenu();
        } else {
          this.showMenu();
        }
      }
    }
    
    showMenu() {
      const exportMenu = document.getElementById('pdfExportMenu') as HTMLElement;
      const exportBtn = document.getElementById('pdfExportBtn') as HTMLElement;
      
      if (exportMenu && exportBtn) {
        exportMenu.classList.add('active');
        exportBtn.classList.add('active');
      }
    }
    
    hideMenu() {
      const exportMenu = document.getElementById('pdfExportMenu') as HTMLElement;
      const exportBtn = document.getElementById('pdfExportBtn') as HTMLElement;
      
      if (exportMenu && exportBtn) {
        exportMenu.classList.remove('active');
        exportBtn.classList.remove('active');
      }
    }
    
    // æ™ºèƒ½æ–‡ä»¶åç”Ÿæˆå‡½æ•°
    generatePDFFileName(): string {
      const currentPath = window.location.pathname;
      const pageTitle = document.title;
      
      // è§£æURLè·¯å¾„ï¼Œæå–æ‰‹å†Œã€ç« èŠ‚ã€å°èŠ‚ä¿¡æ¯
      const pathParts = currentPath.split('/').filter(part => part.length > 0);
      
      let handbook = '1';  // é»˜è®¤æ‰‹å†Œ1
      let chapter = '1';   // é»˜è®¤ç« èŠ‚1
      let section = '1';   // é»˜è®¤å°èŠ‚1
      let keyword = 'content'; // é»˜è®¤å…³é”®è¯
      
      // è§£æURLè·¯å¾„
      if (pathParts.length > 0) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«bookä¿¡æ¯
        const bookMatch = pathParts.find(part => part.startsWith('book'));
        if (bookMatch) {
          handbook = bookMatch.replace('book', '');
        }
        
        // æ£€æŸ¥ç« èŠ‚ä¿¡æ¯
        const chapterMatch = pathParts.find(part => part.match(/^\d{3}_Chapter\d+/));
        if (chapterMatch) {
          const chapterNum = chapterMatch.match(/Chapter(\d+)/);
          if (chapterNum) {
            chapter = chapterNum[1];
          }
        }
        
        // æ£€æŸ¥å°èŠ‚ä¿¡æ¯
        const sectionMatch = pathParts.find(part => part.match(/^\d+\.\d+_/));
        if (sectionMatch) {
          const sectionNum = sectionMatch.match(/^(\d+)\.(\d+)_/);
          if (sectionNum) {
            section = sectionNum[2];
          }
        }
      }
      
      // ä»é¡µé¢æ ‡é¢˜æˆ–URLä¸­æå–å…³é”®è¯
      keyword = this.extractKeyword(pageTitle, currentPath);
      
      // ç”Ÿæˆæ–‡ä»¶åï¼šæ‰‹å†Œ-ç« -èŠ‚-å…³é”®è¯
      const fileName = `${handbook}-${chapter}-${section}-${keyword}`;
      
      console.log('Generated PDF filename:', fileName);
      return fileName;
    }
    
    // æå–å…³é”®è¯
    extractKeyword(title: string, path: string): string {
      // é¢„å®šä¹‰çš„å…³é”®è¯æ˜ å°„
      const keywordMap: { [key: string]: string } = {
        'Self_Awareness': 'wisdom',
        'Understanding_the_World': 'world',
        'Investment_Psychology': 'psychology',
        'Historical_Patterns': 'history',
        'Multibagger_Stocks': 'multibagger',
        'Track_Selection': 'track',
        'Industry_Trends': 'industry',
        'Stock_Screening': 'screening',
        'Trading_Strategies': 'trading',
        'Execution': 'execution',
        'Tools_and_Platforms': 'tools',
        'Data_Analysis': 'analysis',
        'Case_Review': 'case',
        'Personal_Investment': 'personal',
        'Practical_Implementation': 'practical',
        'Market_Trend_Analysis': 'trend',
        'Economic_Cycles': 'cycles',
        'Monetary_Policy': 'monetary',
        'Fiscal_Policy': 'fiscal',
        'Global_Markets': 'global',
        'Economic_Indicators': 'indicators',
        'Forecasting_Models': 'forecast',
        'Risk_Management': 'risk',
        'Asset_Allocation': 'allocation',
        'Market_Timing': 'timing',
        'Quantitative_Analysis': 'quant'
      };
      
      // ä»è·¯å¾„ä¸­åŒ¹é…å…³é”®è¯
      for (const [key, value] of Object.entries(keywordMap)) {
        if (path.includes(key)) {
          return value;
        }
      }
      
      // ä»æ ‡é¢˜ä¸­æå–å…³é”®è¯
      if (title.includes('è®¤çŸ¥') || title.includes('æ™ºæ…§') || title.includes('Self') || title.includes('Awareness')) {
        return 'wisdom';
      } else if (title.includes('ä¸–ç•Œ') || title.includes('World') || title.includes('Understanding')) {
        return 'world';
      } else if (title.includes('å¿ƒç†') || title.includes('Psychology')) {
        return 'psychology';
      } else if (title.includes('é£é™©') || title.includes('Risk')) {
        return 'risk';
      } else if (title.includes('å†å²') || title.includes('History') || title.includes('Historical')) {
        return 'history';
      } else if (title.includes('ç­›é€‰') || title.includes('Screening')) {
        return 'screening';
      } else if (title.includes('äº¤æ˜“') || title.includes('Trading')) {
        return 'trading';
      } else if (title.includes('å·¥å…·') || title.includes('Tools')) {
        return 'tools';
      } else if (title.includes('æ¡ˆä¾‹') || title.includes('Case')) {
        return 'case';
      } else if (title.includes('å®è·µ') || title.includes('Practice')) {
        return 'practice';
      }
      
      // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œä½¿ç”¨é€šç”¨å…³é”®è¯
      return 'content';
    }
    
    async handleExport(exportType: string) {
      const exportBtn = document.getElementById('pdfExportBtn') as HTMLButtonElement;
      if (!exportBtn) return;
      
      // è®°å½•åŸå§‹ HTML ä»¥ä¾¿å®Œæ•´æ¢å¤ï¼ˆåŒ…å«ç®­å¤´ spanï¼‰
      const originalHTML = exportBtn.innerHTML;
      
      try {
        // è‹¥å¯¼å‡ºæ•´ç« /æ•´å†Œæ—¶æ‰æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (exportType !== 'current-page') {
          exportBtn.innerHTML = 'å¯¼å‡ºä¸­...';
          exportBtn.disabled = true;
        }
        
        switch (exportType) {
          case 'current-page': {
            await this.generatePdfFromCurrentPage();
            break;
          }
          case 'current-chapter':
          case 'full-book':
            alert('æ•´ç«  / æ•´å†Œ PDF å¯¼å‡ºåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
            break;
          default:
            throw new Error('æœªçŸ¥çš„å¯¼å‡ºç±»å‹');
        }
        
      } catch (error) {
        console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
        const errorMessage = error instanceof Error ? error.message : 'PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•';
        this.showErrorMessage(errorMessage);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        exportBtn.innerHTML = originalHTML;
        exportBtn.disabled = false;
      }
    }
    
    async generatePdfFromCurrentPage() {
      // ç”Ÿæˆæ™ºèƒ½æ–‡ä»¶å
      const fileName = this.generatePDFFileName();
      
      // ä¿®æ”¹é¡µé¢æ ‡é¢˜ä»¥å½±å“é»˜è®¤æ–‡ä»¶å
      const originalTitle = document.title;
      document.title = fileName;
      
      // ç«‹å³ä¼˜åŒ–é¡µé¢æ ·å¼ç”¨äºæ‰“å°
      this.optimizePageForPrint();
      
      // æœ€å°åŒ–ç­‰å¾…æ—¶é—´ - åªç­‰å¾…å…³é”®æ ·å¼åº”ç”¨
      await new Promise(resolve => setTimeout(resolve, 50));
      
      // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ‰“å°API
      window.print();
      
      // ç«‹å³æ¢å¤åŸå§‹æ ‡é¢˜å’Œæ ·å¼
      document.title = originalTitle;
      this.restoreOriginalStyles();
    }
    
    optimizePageForPrint() {
      const printStyle = document.createElement('style');
      printStyle.id = 'pdf-export-print-style';
      printStyle.textContent = `
        @media print {
          /* å¿«é€Ÿéšè—æ‰€æœ‰è£…é¥°æ€§å’Œäº¤äº’æ€§å…ƒç´  */
          nav, .navbar, .sidebar, .pdf-export-dropdown, .theme-toggle,
          .back-to-top, .search-box, .print-hide, header, footer,
          .header, .footer, button, input, select, textarea,
          .interactive, .tooltip, .modal, .dropdown, .menu,
          .breadcrumb, .pagination, .toc-sidebar, .share-buttons,
          .reading-time, .mobile-menu-toggle { 
            display: none !important; 
          }
          
          /* å®Œå…¨ç§»é™¤æ‰€æœ‰emojiã€å›¾æ ‡å’Œè£…é¥°æ€§å…ƒç´  */
          .emoji, .icon, .card-icon, .decorative-image, .background-image,
          h1::before, h2::before, h3::before, h4::before, h5::before, h6::before,
          *::before, *::after { 
            display: none !important; 
            content: none !important; 
          }
          
          /* æç®€åŒ–æ‰€æœ‰æ ·å¼ - æ€§èƒ½ä¼˜åŒ– */
          * {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
            border-radius: 0 !important;
            outline: none !important;
            filter: none !important;
            transform: none !important;
            transition: none !important;
            animation: none !important;
          }
          
          /* åŸºç¡€é¡µé¢è®¾ç½® */
          html, body {
            background: white !important;
            color: black !important;
            font-family: Arial, sans-serif !important;
            font-size: 11pt !important;
            line-height: 1.3 !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          
          /* ä¸»è¦å†…å®¹åŒºåŸŸ */
          main, .main-content, .content {
            display: block !important;
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          
          /* å®Œå…¨å»é™¤æ‰€æœ‰è£…é¥°æ€§å®¹å™¨çš„è¾¹æ¡†å’ŒèƒŒæ™¯ */
          .chapter-overview, .overview-item, .overview-card, .card, .card-green,
          .wisdom-section, .science-section, .practice-section, .key-points,
          .core-summary, .key-metrics, .container, .wrapper, .section {
            display: block !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            margin: 0.1em 0 !important;
            padding: 0 !important;
          }
          
          /* å°†ç½‘æ ¼å¸ƒå±€è½¬æ¢ä¸ºç®€å•çš„å—çº§å¸ƒå±€ */
          .overview-grid, .chapters-grid, .content-grid {
            display: block !important;
            margin: 0 !important;
            padding: 0 !important;
          }
          
          /* æ ‡é¢˜æ ·å¼ - æç®€æ— è£…é¥° */
          h1, h2, h3, h4, h5, h6 {
            color: black !important;
            font-weight: bold !important;
            text-align: left !important;
            margin: 0.2em 0 0.1em 0 !important;
            padding: 0 !important;
          }
          
          h1 { font-size: 16pt !important; }
          h2 { font-size: 14pt !important; }
          h3 { font-size: 12pt !important; }
          h4 { font-size: 11pt !important; }
          h5, h6 { font-size: 10pt !important; }
          
          /* æ®µè½å’Œæ–‡æœ¬ - ç´§å‡‘å¸ƒå±€ */
          p { margin: 0.1em 0 !important; text-align: left !important; }
          
          /* åˆ—è¡¨ - æç®€æ ·å¼ */
          ul, ol { margin: 0.1em 0 !important; padding-left: 1em !important; }
          li { margin: 0.05em 0 !important; }
          
          /* å¼ºè°ƒæ–‡æœ¬ */
          strong, b { font-weight: bold !important; color: black !important; }
          em, i { font-style: italic !important; color: black !important; }
          
          /* é“¾æ¥ */
          a { color: black !important; text-decoration: none !important; }
          
          /* å¼•ç”¨å— - æç®€ */
          blockquote {
            margin: 0.1em 0 !important;
            padding-left: 0.5em !important;
            border-left: 1px solid black !important;
            font-style: italic !important;
          }
          
          /* ä»£ç å— - æç®€ */
          pre, code {
            font-family: monospace !important;
            font-size: 9pt !important;
            background: #f5f5f5 !important;
            padding: 0.1em !important;
            margin: 0.1em 0 !important;
            border: 1px solid #ccc !important;
          }
          
          /* è¡¨æ ¼ - æç®€ */
          table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 0.2em 0 !important;
            font-size: 9pt !important;
          }
          
          th, td {
            border: 1px solid black !important;
            padding: 0.1em !important;
            text-align: left !important;
          }
          
          th { background: #f0f0f0 !important; font-weight: bold !important; }
          
          /* å›¾ç‰‡ */
          img {
            max-width: 100% !important;
            height: auto !important;
            display: block !important;
            margin: 0.1em 0 !important;
          }
          
          /* æ€§èƒ½ä¼˜åŒ– */
          * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      `;
      document.head.appendChild(printStyle);
    }
    
    restoreOriginalStyles() {
      const printStyle = document.getElementById('pdf-export-print-style');
      if (printStyle) {
        printStyle.remove();
      }
    }
    
    showErrorMessage(message: string) {
      const errorElement = document.createElement('div');
      errorElement.className = 'pdf-export-error';
      errorElement.innerHTML = `
        <div class="pdf-error-content">
          <div class="pdf-error-icon">âŒ</div>
          <div class="pdf-error-text">${message}</div>
          <button class="pdf-error-close">å…³é—­</button>
        </div>
      `;
      
      // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const closeButton = errorElement.querySelector('.pdf-error-close');
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          errorElement.remove();
        });
      }
      
      document.body.appendChild(errorElement);
      
      setTimeout(() => {
        if (errorElement.parentNode) {
          errorElement.remove();
        }
      }, 5000);
    }
  }
  
  // åˆå§‹åŒ–PDFå¯¼å‡ºæ§åˆ¶å™¨
  new PDFExportController();
</script>

<style>
  .pdf-export-dropdown {
    position: relative;
    display: inline-block;
  }
  
  .pdf-export-btn {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    color: var(--text-primary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 80px;
  }
  
  .pdf-export-btn:hover,
  .pdf-export-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }
  
  .pdf-export-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .pdf-dropdown-arrow {
    font-size: 0.7rem;
    transition: transform 0.2s ease;
  }
  
  .pdf-export-btn.active .pdf-dropdown-arrow {
    transform: rotate(180deg);
  }
  
  .pdf-export-menu {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    min-width: 220px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 1000;
  }
  
  .pdf-export-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .pdf-export-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid var(--border-color);
  }
  
  .pdf-export-option:last-child {
    border-bottom: none;
  }
  
  .pdf-export-option:hover {
    background: var(--bg-primary);
  }
  
  .pdf-option-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  
  .pdf-option-content {
    flex: 1;
  }
  
  .pdf-option-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }
  
  .pdf-option-desc {
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.2;
  }
  
  /* é”™è¯¯æç¤ºæ ·å¼ */
  .pdf-export-error {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card-bg);
    border: 1px solid #ef4444;
    border-left: 4px solid #ef4444;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    animation: pdf-slide-in 0.3s ease;
    max-width: 350px;
  }
  
  .pdf-error-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
  }
  
  .pdf-error-icon {
    flex-shrink: 0;
    font-size: 1.1rem;
  }
  
  .pdf-error-text {
    flex: 1;
    color: var(--text-primary);
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  .pdf-error-close {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .pdf-error-close:hover {
    background: #dc2626;
  }
  
  @keyframes pdf-slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* æš—è‰²ä¸»é¢˜é€‚é… */
  [data-theme="dark"] .pdf-export-btn {
    background: var(--card-bg);
    color: var(--text-primary);
    border-color: var(--border-color);
  }
  
  [data-theme="dark"] .pdf-export-btn:hover,
  [data-theme="dark"] .pdf-export-btn.active {
    background: var(--primary-color);
    color: white;
  }
  
  [data-theme="dark"] .pdf-export-menu {
    background: var(--card-bg);
    border-color: var(--border-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  [data-theme="dark"] .pdf-export-option:hover {
    background: var(--bg-primary);
  }
  
  [data-theme="dark"] .pdf-export-error {
    background: var(--card-bg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .pdf-export-menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 280px;
    }
    
    .pdf-export-menu.active {
      transform: translate(-50%, -50%);
    }
    
    .pdf-export-error {
      left: 10px;
      right: 10px;
      max-width: none;
    }
  }
            margin: 0.1em 0 !important;
          }
          
          /* æ€§èƒ½ä¼˜åŒ– */
          * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      `;
      document.head.appendChild(printStyle);
    }
    
    restoreOriginalStyles() {
      const printStyle = document.getElementById('pdf-export-print-style');
      if (printStyle) {
        printStyle.remove();
      }
    }
    
    showErrorMessage(message: string) {
      const errorElement = document.createElement('div');
      errorElement.className = 'pdf-export-error';
      errorElement.innerHTML = `
        <div class="pdf-error-content">
          <div class="pdf-error-icon">âŒ</div>
          <div class="pdf-error-text">${message}</div>
          <button class="pdf-error-close">å…³é—­</button>
        </div>
      `;
      
      // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const closeButton = errorElement.querySelector('.pdf-error-close');
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          errorElement.remove();
        });
      }
      
      document.body.appendChild(errorElement);
      
      setTimeout(() => {
        if (errorElement.parentNode) {
          errorElement.remove();
        }
      }, 5000);
    }
  }
  
  // åˆå§‹åŒ–PDFå¯¼å‡ºæ§åˆ¶å™¨
  new PDFExportController();
</script>

<style>
  .pdf-export-dropdown {
    position: relative;
    display: inline-block;
  }
  
  .pdf-export-btn {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    color: var(--text-primary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 80px;
  }
  
  .pdf-export-btn:hover,
  .pdf-export-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }
  
  .pdf-export-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .pdf-dropdown-arrow {
    font-size: 0.7rem;
    transition: transform 0.2s ease;
  }
  
  .pdf-export-btn.active .pdf-dropdown-arrow {
    transform: rotate(180deg);
  }
  
  .pdf-export-menu {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    min-width: 220px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 1000;
  }
  
  .pdf-export-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .pdf-export-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid var(--border-color);
  }
  
  .pdf-export-option:last-child {
    border-bottom: none;
  }
  
  .pdf-export-option:hover {
    background: var(--bg-primary);
  }
  
  .pdf-option-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  
  .pdf-option-content {
    flex: 1;
  }
  
  .pdf-option-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }
  
  .pdf-option-desc {
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.2;
  }
  
  /* é”™è¯¯æç¤ºæ ·å¼ */
  .pdf-export-error {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card-bg);
    border: 1px solid #ef4444;
    border-left: 4px solid #ef4444;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    animation: pdf-slide-in 0.3s ease;
    max-width: 350px;
  }
  
  .pdf-error-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
  }
  
  .pdf-error-icon {
    flex-shrink: 0;
    font-size: 1.1rem;
  }
  
  .pdf-error-text {
    flex: 1;
    color: var(--text-primary);
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  .pdf-error-close {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .pdf-error-close:hover {
    background: #dc2626;
  }
  
  @keyframes pdf-slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* æš—è‰²ä¸»é¢˜é€‚é… */
  [data-theme="dark"] .pdf-export-btn {
    background: var(--card-bg);
    color: var(--text-primary);
    border-color: var(--border-color);
  }
  
  [data-theme="dark"] .pdf-export-btn:hover,
  [data-theme="dark"] .pdf-export-btn.active {
    background: var(--primary-color);
    color: white;
  }
  
  [data-theme="dark"] .pdf-export-menu {
    background: var(--card-bg);
    border-color: var(--border-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  [data-theme="dark"] .pdf-export-option:hover {
    background: var(--bg-primary);
  }
  
  [data-theme="dark"] .pdf-export-error {
    background: var(--card-bg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .pdf-export-menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 280px;
    }
    
    .pdf-export-menu.active {
      transform: translate(-50%, -50%);
    }
    
    .pdf-export-error {
      left: 10px;
      right: 10px;
      max-width: none;
    }
  }
  }</style> 
