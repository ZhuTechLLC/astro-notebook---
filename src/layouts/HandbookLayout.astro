---
import Layout from './Layout.astro';
import GlossaryTerm from '../components/GlossaryTerm.astro';

export interface Props {
  title: string;
  book: 'theory' | 'macro' | 'stocks' | 'technical' | 'quantitative';
  chapter?: string;
  lang?: string;
  alt?: string;
  description?: string;
  updateDate?: string;
}

const { 
  title, 
  book, 
  chapter = '', 
  lang = 'zh-CN', 
  alt = '',
  description = '',
  updateDate = new Date().toISOString().split('T')[0]
} = Astro.props;
---

<head>
  <meta charset="UTF-8" />
  <meta name="description" content="ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†Œ - å®Œæ•´çŸ¥è¯†ä½“ç³»" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="generator" content={Astro.generator} />
  <title>{title}</title>
  <script type="text/javascript">
    window.MathJax = window.MathJax || {};
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: ['base', 'ams', 'noerrors', 'noundefined']
      },
      chtml: {
        scale: 1.0,
        minScale: 0.5,
        matchFontHeight: true,
        displayAlign: 'center',
        displayIndent: '0',
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      },
      options: {
        renderActions: {
          addMenu: [],
          checkLoading: []
        },
        enableMenu: false,
        menuOptions: {
          settings: {
            texHints: true,
            semantics: false,
            renderer: 'CHTML'
          }
        }
      },
      startup: {
        pageReady: () => {
          return MathJax.startup.defaultPageReady().then(() => {
            console.log('MathJax is loaded and ready');
          });
        }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
  
  <!-- MathJaxæ ·å¼ä¼˜åŒ– -->
  <style>
    /* MathJaxå…¬å¼æ ·å¼ä¼˜åŒ– */
    .MathJax {
      font-size: 1.1em !important;
      line-height: 1.4 !important;
    }
    
    /* æ˜¾ç¤ºå…¬å¼æ ·å¼ */
    .MathJax_Display {
      margin: 1.5em 0 !important;
      text-align: center !important;
    }
    
    /* å†…è”å…¬å¼æ ·å¼ */
    .MathJax_Display .MathJax {
      text-align: left !important;
    }
    
    /* å…¬å¼å­—ä½“ä¼˜åŒ– */
    .MathJax .MathJax_MathML {
      font-family: 'Times New Roman', serif !important;
    }
    
    /* æš—è‰²ä¸»é¢˜ä¸‹çš„å…¬å¼æ ·å¼ */
    [data-theme="dark"] .MathJax {
      color: #e5e7eb !important;
    }
    
    /* status-labelä¸­çš„å…¬å¼æ ·å¼ */
    .status-label .MathJax {
      font-size: 0.9em !important;
      margin: 0.2em 0 !important;
    }
    
    /* ç¡®ä¿å…¬å¼åœ¨å¡ç‰‡ä¸­æ­£ç¡®æ˜¾ç¤º */
    .status-card .MathJax_Display {
      margin: 0.5em 0 !important;
    }
    
    /* å…¬å¼å®¹å™¨æ ·å¼ */
    .formula-display {
      background: rgba(59, 130, 246, 0.05);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
    }
    
    [data-theme="dark"] .formula-display {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }
  </style>
  <!-- KaTeXæ ·å¼å·²ç§»é™¤ï¼Œå¦‚éœ€MathJaxå‰ç«¯æ¸²æŸ“å¯åœ¨æ­¤å¼•å…¥MathJax CDN -->
  <link rel="stylesheet" href="/src/styles/style.css" />
  <link rel="stylesheet" href="/src/styles/components.css" />
  <link rel="stylesheet" href="/src/styles/enhanced-flowchart.css" />
  
  <!-- å®Œç¾ä¸»ä¹‰çº§åˆ«çš„Checkboxæ ·å¼ä¿®å¤ -->
  <style>
    /* ğŸ¯ ç»ˆæè§£å†³æ–¹æ¡ˆï¼šå®Œå…¨ç§»é™¤æ‰€æœ‰checkboxåˆ—è¡¨çš„é¡¹ç›®ç¬¦å· */
    .checklist-list,
    .checklist-section ul,
    .checklist-section ol {
      list-style-type: none !important;
      list-style: none !important;
      list-style-image: none !important;
      padding-left: 0 !important;
      margin-left: 0 !important;
    }
    
    .checklist-list li,
    .checklist-section ul li,
    .checklist-section ol li {
      list-style-type: none !important;
      list-style: none !important;
      list-style-image: none !important;
      display: flex !important;
      align-items: flex-start !important;
      gap: 0.5rem !important;
      padding: 0.25rem 0 !important;
      margin-bottom: 0.5rem !important;
      line-height: 1.5 !important;
      position: relative;
    }
    
    .checklist-list li::before,
    .checklist-section ul li::before,
    .checklist-section ol li::before,
    .checklist-list li::marker,
    .checklist-section ul li::marker,
    .checklist-section ol li::marker {
      content: none !important;
      display: none !important;
      visibility: hidden !important;
    }
    
    /* ç¡®ä¿checkboxè¾“å…¥æ¡†æ­£ç¡®å¯¹é½ */
    .checklist-list li input[type="checkbox"],
    .checklist-section input[type="checkbox"] {
      margin: 0 !important;
      margin-top: 0.1rem !important;
      flex-shrink: 0 !important;
    }
  </style>

  <!-- ğŸ¨ Status-CardsèƒŒæ™¯è‰²ä¿®å¤ - é¿å…çº¯ç™½èƒŒæ™¯ -->
  <style>
    .status-card.green {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
      border-left: 4px solid #16a34a !important;
    }

    .status-card.yellow {
      background: linear-gradient(135deg, #fefce8 0%, #fef08a 100%) !important;
      border-left: 4px solid #d97706 !important;
    }

    .status-card.red {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%) !important;
      border-left: 4px solid #dc2626 !important;
    }

    .status-card.blue {
      background: linear-gradient(135deg, #eff6ff 0%, #bfdbfe 100%) !important;
      border-left: 4px solid #2563eb !important;
    }

    .status-card.purple {
      background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 100%) !important;
      border-left: 4px solid #9333ea !important;
    }

    .status-card.gray {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
      border-left: 4px solid #6b7280 !important;
    }

    .status-card.orange {
      background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%) !important;
      border-left: 4px solid #ea580c !important;
    }

    /* æš—è‰²ä¸»é¢˜ä¸‹çš„çº¢è‰²å¡ç‰‡ä¿®å¤ */
    [data-theme="dark"] .status-card.red {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%) !important;
      color: #fee2e2 !important;
    }

    /* ç¡®ä¿æ‰€æœ‰status-cardéƒ½æœ‰åˆé€‚çš„æ–‡å­—é¢œè‰² */
    .status-card.green .status-content {
      color: #166534 !important;
    }

    .status-card.yellow .status-content {
      color: #92400e !important;
    }

    .status-card.red .status-content {
      color: #dc2626 !important;
    }

    .status-card.blue .status-content {
      color: #1e40af !important;
    }

    .status-card.purple .status-content {
      color: #6b21a8 !important;
    }

    .status-card.gray .status-content {
      color: #4b5563 !important;
    }

    .status-card.orange .status-content {
      color: #c2410c !important;
    }

    /* ğŸ”§ æ©™è‰²status-labelä¿®å¤ - ç¡®ä¿ç™½è‰²æ–‡å­—å’Œæ©™è‰²èƒŒæ™¯ */
    .status-card.orange .status-label {
      background: #ea580c !important;
      background-color: #ea580c !important;
      color: white !important;
      color: #ffffff !important;
      font-weight: 500 !important;
      padding: 0.25rem 0.75rem !important;
      border-radius: 16px !important;
      font-size: 0.8rem !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }

    /* ç¡®ä¿æ©™è‰²å¡ç‰‡æ ‡é¢˜é¢œè‰²æ­£ç¡® */
    .status-card.orange .status-header h4 {
      color: #c2410c !important;
    }

    /* é¢å¤–çš„é€‰æ‹©å™¨ç¡®ä¿æ ·å¼ç”Ÿæ•ˆ */
    div.status-card.orange div.status-header div.status-label {
      background: #ea580c !important;
      color: white !important;
    }
  </style>

  <!-- ğŸŒ™ Orangeæš—è‰²æ¨¡å¼å®šä¹‰ - è¡¥å……components.cssä¸­ç¼ºå¤±çš„å®šä¹‰ -->
  <style>
    /* Orangeæš—è‰²æ¨¡å¼èƒŒæ™¯ */
    [data-theme="dark"] .status-card.orange {
      background: linear-gradient(135deg, #7c2d12 0%, #9a3412 100%);
      color: #fed7aa;
    }

    /* Orangeæš—è‰²æ¨¡å¼æ ‡é¢˜é¢œè‰² */
    [data-theme="dark"] .status-card.orange .status-header h4 {
      color: #fb923c;
    }

    /* Orangeæš—è‰²æ¨¡å¼å†…å®¹é¢œè‰² */
    [data-theme="dark"] .status-card.orange .status-content {
      color: #fed7aa;
    }
  </style>
</head>

<Layout 
  title={title} 
  currentBook={book} 
  currentChapter={chapter}
  lang={lang}
  alt={alt}
>
  <slot />
  <GlossaryTerm term="" />
</Layout>

<style>
  /* å¼•ç”¨ç»„ä»¶æ ·å¼ */
  @import '/src/styles/components.css';
  @import '/src/styles/alignment-fix.css';
  
  /* é¡µé¢ç‰¹å®šæ ·å¼ */
  .handbook-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  /* ç¡®ä¿VS Codeä¸»é¢˜ä¼˜å…ˆçº§ */
  [data-theme="dark"] pre,
  [data-theme="dark"] code {
    background: #1e1e1e !important;
    color: #d4d4d4 !important;
    border: 1px solid #3e3e3e !important;
  }
</style>

<script>
  // æ™ºèƒ½çŠ¶æ€å¡ç‰‡å¸ƒå±€æ£€æµ‹
  function initSmartStatusCards() {
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSmartStatusCards);
      return;
    }

    const statusCardsContainers = document.querySelectorAll('.status-cards');
    
    statusCardsContainers.forEach(container => {
      const cards = container.querySelectorAll('.status-card');
      const cardCount = cards.length;
      
      // å¤„ç†å•å¼ å¡ç‰‡çš„å†…å®¹åˆ†æ
      if (cardCount === 1) {
        analyzeSingleCard(cards[0]);
        return;
      }
      
      // åªå¤„ç†3å¼ æˆ–4å¼ å¡ç‰‡çš„å®¹å™¨
      if (cardCount !== 3 && cardCount !== 4) return;
      
      let shouldUseCompactLayout = true;
      let totalContentLength = 0;
      
      cards.forEach(card => {
        const title = card.querySelector('.status-header h4');
        const content = card.querySelector('.status-content');
        const labels = card.querySelectorAll('.status-label');
        
        // æ£€æµ‹å†…å®¹é•¿åº¦
        const titleLength = title ? (title.textContent || '').trim().length : 0;
        const contentLength = content ? (content.textContent || '').trim().length : 0;
        const labelCount = labels.length;
        
        totalContentLength += titleLength + contentLength;
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨æ ‡å‡†å¸ƒå±€ï¼ˆéç´§å‡‘ï¼‰
        const titleThreshold = cardCount === 3 ? 30 : 25;  // 3å¼ å¡ç‰‡å…è®¸ç¨é•¿æ ‡é¢˜
        const contentThreshold = cardCount === 3 ? 120 : 100;  // 3å¼ å¡ç‰‡å…è®¸ç¨å¤šå†…å®¹
        
        if (titleLength > titleThreshold || contentLength > contentThreshold || labelCount > 1) {
          shouldUseCompactLayout = false;
        }
      });
      
      // å¦‚æœå¹³å‡æ¯å¼ å¡ç‰‡å†…å®¹è¶…è¿‡é˜ˆå€¼ï¼Œä¹Ÿä½¿ç”¨æ ‡å‡†å¸ƒå±€
      const avgContentThreshold = cardCount === 3 ? 50 : 40;
      if (totalContentLength / cardCount > avgContentThreshold) {
        shouldUseCompactLayout = false;
      }
      
      // æ¸…é™¤æ‰€æœ‰å¸ƒå±€ç±»
      container.classList.remove('compact-3', 'compact-4', 'compact-layout', 'grid-layout');
      
      // åº”ç”¨ç›¸åº”çš„å¸ƒå±€ç±»
      if (shouldUseCompactLayout) {
        if (cardCount === 3) {
          container.classList.add('compact-3');
        } else if (cardCount === 4) {
          container.classList.add('compact-4');
        }
      } else {
        // å†…å®¹è¾ƒå¤šæ—¶ï¼Œ3å¼ å¡ç‰‡ä½¿ç”¨é»˜è®¤auto-fitï¼Œ4å¼ å¡ç‰‡ä½¿ç”¨grid-layout
        if (cardCount === 4) {
          container.classList.add('grid-layout');
        }
        // 3å¼ å¡ç‰‡ä¸æ·»åŠ ç‰¹æ®Šç±»ï¼Œä½¿ç”¨é»˜è®¤çš„auto-fitå¸ƒå±€
      }
    });
  }

  // åˆ†æå•å¼ å¡ç‰‡æ˜¯å¦éœ€è¦æ‹†åˆ†ä¸ºå¤šä¸ªå°å¡ç‰‡
  function analyzeSingleCard(card) {
    // è·³è¿‡å·²ç»æ˜¯multi-cardçš„å¡ç‰‡
    if (card.classList.contains('multi-card')) return;
    
    const content = card.querySelector('.status-content');
    if (!content) return;
    
    const contentText = (content.textContent || '').trim();
    const contentLength = contentText.length;
    
    // æ£€æµ‹æ˜¯å¦æœ‰æ˜æ˜¾çš„åˆ†æ®µç»“æ„
    const paragraphs = content.querySelectorAll('p');
    const lists = content.querySelectorAll('ul, ol');
    const strongElements = content.querySelectorAll('strong');
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹†åˆ†çš„æ¡ä»¶
    const shouldSplit = (
      contentLength > 300 ||  // å†…å®¹è¶…è¿‡300å­—ç¬¦
      paragraphs.length > 3 ||  // è¶…è¿‡3ä¸ªæ®µè½
      lists.length > 1 ||  // è¶…è¿‡1ä¸ªåˆ—è¡¨
      strongElements.length > 2  // è¶…è¿‡2ä¸ªå¼ºè°ƒå…ƒç´ 
    );
    
    if (shouldSplit) {
      // æ·»åŠ å»ºè®®æ‹†åˆ†çš„æ ‡è®°ç±»
      card.classList.add('suggest-multi-card');
      
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªæç¤ºæˆ–è‡ªåŠ¨è½¬æ¢é€»è¾‘
      console.log('å»ºè®®å°†æ­¤å¡ç‰‡æ‹†åˆ†ä¸ºå¤šä¸ªå°å¡ç‰‡:', card);
    }
  }

  // åˆå§‹åŒ–
  initSmartStatusCards();
  
  // ç›‘å¬ä¸»é¢˜åˆ‡æ¢ï¼Œé‡æ–°è®¡ç®—å¸ƒå±€
  document.addEventListener('themeChange', initSmartStatusCards);
</script>