---
export interface Props {
  title: string;
  lang?: string;
  alt?: string;
  currentBook?: string;
  currentChapter?: string;
}

const { title, lang = 'zh-CN', alt = '', currentBook = 'theory', currentChapter = '' } = Astro.props;
const isEn = lang === 'en' || (typeof window !== 'undefined' && window.location.pathname.startsWith('/en/'));
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†Œ - å®Œæ•´çŸ¥è¯†ä½“ç³»" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
  </head>
  <body>
    <div class="container">
      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
      <header class="top-nav" id="topNav">
        <div class="nav-left">
          <button class="sidebar-toggle" id="sidebarToggle" aria-label="åˆ‡æ¢ä¾§è¾¹æ ">ğŸ“š</button>
        </div>
        <div class="nav-right">
          <button id="homeBtn" class="nav-control-btn home-btn" title="è¿”å›é¦–é¡µ">ğŸ </button>
          <button id="tocBtn" class="nav-control-btn toc-btn" title="è¿”å›ç›®å½•">ğŸ“š</button>
          <button id="prevPageBtn" class="page-nav-btn" title="ä¸Šä¸€é¡µ">ä¸Šä¸€é¡µ</button>
          <button id="nextPageBtn" class="page-nav-btn" title="ä¸‹ä¸€é¡µ">ä¸‹ä¸€é¡µ</button>
          <button id="toggleReadingMode" class="reading-btn" title="ä¸“æ³¨é˜…è¯»æ¨¡å¼">ğŸ“–</button>
          <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
            <span class="theme-icon">ğŸŒ™</span>
          </button>
          <button id="decreaseFont" class="font-btn" title="ç¼©å°å­—ä½“">A-</button>
          <button id="increaseFont" class="font-btn" title="æ”¾å¤§å­—ä½“">A+</button>
          <a class="lang-btn" id="langSwitchEn" href={alt} title="English">EN</a>
          <a class="lang-btn" id="langSwitchCn" href={alt} title="ä¸­æ–‡">CN</a>
        </div>
      </header>

      <!-- é˜…è¯»è¿›åº¦æ¡ï¼ˆä¸“æ³¨æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
      <div class="reading-progress" id="readingProgress" style="display: none;">
        <div class="reading-progress-bar" id="readingProgressBar"></div>
      </div>
      
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2 id="sidebarTitle">ğŸ“ˆ ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†Œ</h2>
        </div>
        
        <nav class="sidebar-nav" id="sidebarNav">
          <!-- åŠ¨æ€ç”Ÿæˆå¯¼èˆªå†…å®¹ -->
        </nav>
      </aside>

      <!-- ä¸»å†…å®¹åŒº -->
      <main class="main-content" id="mainContent">
        <slot />
      </main>



      <!-- ç« èŠ‚å¯¼èˆªï¼ˆä»…book1ç« èŠ‚é¡µé¢æ˜¾ç¤ºï¼‰ -->
      <div class="chapter-nav" id="chapterNav" style="display: none;">
        <button class="chapter-btn prev-chapter" id="prevChapter" disabled>
          <span class="chapter-icon">â†</span>
          <span class="chapter-text">ä¸Šä¸€ç« </span>
        </button>
        <button class="chapter-btn next-chapter" id="nextChapter">
          <span class="chapter-text">ä¸‹ä¸€ç« </span>
          <span class="chapter-icon">â†’</span>
        </button>
      </div>

      <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
      <button id="backToTop" class="back-to-top" aria-label="å›åˆ°é¡¶éƒ¨" style="display: none;">â†‘</button>
    </div>

    <style is:global>
      @import '../styles/style.css';
      @import '../styles/components.css';

      /* å®¹å™¨ */
      .container {
        position: relative;
        min-height: 100vh;
      }

      /* é¡¶éƒ¨å¯¼èˆªæ  */
      .top-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 16px;
        height: 48px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1100;
        transition: all 0.3s ease;
      }

      .nav-left, .nav-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* æŒ‰é’®åŸºç¡€æ ·å¼ */
      .sidebar-toggle,
      .reading-btn,
      .theme-toggle,
      .font-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      .sidebar-toggle:hover,
      .reading-btn:hover,
      .theme-toggle:hover,
      .font-btn:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      }

      .sidebar-toggle:active,
      .reading-btn:active,
      .theme-toggle:active,
      .font-btn:active {
        transform: scale(0.95);
      }

      /* ç¿»é¡µæŒ‰é’®æ ·å¼ */
      .page-nav-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 50px;
        height: 40px;
      }

      .page-nav-btn:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      }

      .page-nav-btn:active {
        transform: translateY(0);
      }

      #prevPageBtn {
        background: linear-gradient(135deg, #2196f3, #42a5f5);
      }

      #nextPageBtn {
        background: linear-gradient(135deg, #ff9800, #ffb74d);
      }

      #prevPageBtn:hover {
        background: linear-gradient(135deg, #1976d2, #2196f3);
      }

      #nextPageBtn:hover {
        background: linear-gradient(135deg, #f57c00, #ff9800);
      }

      #prevPageBtn:disabled,
      #nextPageBtn:disabled {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: not-allowed;
        opacity: 0.6;
      }

      #prevPageBtn:disabled:hover,
      #nextPageBtn:disabled:hover {
        transform: none;
        background: var(--bg-secondary);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      /* é‡æ–°å®šä¹‰ç¿»é¡µæŒ‰é’®å®Œæ•´æ ·å¼ */
      .page-nav-btn {
        padding: 8px 12px;
        border-radius: 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 60px;
        height: 40px;
      }

      .page-nav-btn:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      }

      .page-nav-btn:active {
        transform: translateY(0);
      }

      /* å¯¼èˆªæ§åˆ¶æŒ‰é’®æ ·å¼ */
      .nav-control-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        color: white;
        font-weight: 600;
      }

      .nav-control-btn.home-btn {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
      }

      .nav-control-btn.toc-btn {
        background: linear-gradient(135deg, #ff9800, #ffb74d);
      }

      .nav-control-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      }

      .nav-control-btn:active {
        transform: translateY(0) scale(0.95);
      }

      /* è¯­è¨€åˆ‡æ¢æŒ‰é’® */
      .lang-btn {
        padding: 8px 16px;
        border-radius: 20px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
      }

      .lang-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
      }

      /* é˜…è¯»è¿›åº¦æ¡ */
      .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--bg-secondary);
        z-index: 1200;
      }

      .reading-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        width: 0%;
        transition: width 0.3s ease;
      }

      /* ä¾§è¾¹æ  */
      .sidebar {
        position: fixed;
        top: 48px;
        left: -320px;
        width: 320px;
        height: calc(100vh - 48px);
        background: var(--card-bg);
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        transition: left 0.3s ease;
        z-index: 1000;
        box-shadow: 4px 0 20px rgba(0,0,0,0.15);
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-header {
        padding: 24px 20px;
        border-bottom: 2px solid var(--border-color);
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        position: relative;
      }

      .sidebar-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255,255,255,0.2);
      }

      .sidebar-header h2 {
        margin: 0;
        color: white;
        font-size: 1.3rem;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      }

      .sidebar-nav {
        padding: 16px 0;
      }

      .nav-group {
        margin-bottom: 8px;
      }

      .nav-group-title {
        padding: 12px 20px 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 8px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        margin: 2px 0;
        position: relative;
      }

      .nav-item:hover {
        background: var(--bg-secondary);
        border-left-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateX(4px);
      }

      .nav-item.active {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        border-left-color: var(--primary-dark);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .nav-item.active::after {
        content: '';
        position: absolute;
        right: 16px;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
      }

      .chapter-number {
        margin-right: 14px;
        font-size: 1.2rem;
        min-width: 28px;
        text-align: center;
      }

      .chapter-title {
        font-size: 0.95rem;
        line-height: 1.5;
        font-weight: 500;
      }

      /* ä¾§è¾¹æ æ»šåŠ¨æ¡ç¾åŒ– */
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
      }

      .sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
      }

      /* ä¸»å†…å®¹åŒº */
      .main-content {
        margin-top: 48px;
        padding: 0 20px 20px 20px;
        min-height: calc(100vh - 48px);
      }



      /* ç« èŠ‚å¯¼èˆª */
      .chapter-nav {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 16px;
        z-index: 900;
      }

      .chapter-btn {
        display: flex;
        align-items: center;
          gap: 8px;
        padding: 12px 20px;
        border-radius: 25px;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .chapter-btn:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }

      .chapter-btn:disabled {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: not-allowed;
        opacity: 0.6;
      }

      .chapter-icon {
        font-size: 1.1rem;
      }

      .chapter-text {
        font-size: 0.9rem;
      }

      /* å›åˆ°é¡¶éƒ¨æŒ‰é’® */
      .back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 900;
      }

      .back-to-top:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }

      /* ä¸“æ³¨é˜…è¯»æ¨¡å¼ */
      .focus-mode .top-nav {
        background: var(--bg-overlay);
        backdrop-filter: blur(10px);
        border: none;
        box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      }

      .focus-mode .top-nav .nav-left {
        visibility: hidden;
      }

      .focus-mode .top-nav .nav-right {
        display: flex;
        gap: 12px;
      }

      .focus-mode .top-nav .page-nav-btn {
        display: flex;
      }

      .focus-mode .top-nav .reading-btn {
        display: flex;
      }

      .focus-mode .top-nav .theme-toggle {
        display: flex;
      }

      .focus-mode .top-nav .font-btn {
        display: flex;
      }

      .focus-mode .top-nav .lang-btn {
        display: flex;
      }

      .focus-mode .sidebar {
        display: none;
      }

      .focus-mode .main-content {
        margin-left: 0;
        max-width: 800px;
        margin: 48px auto 0;
        padding: 40px;
        background: var(--card-bg);
        border-radius: 15px;
        box-shadow: var(--shadow);
      }

      .focus-mode .left-nav,
      .focus-mode .chapter-nav {
        display: none;
      }

      .focus-mode .back-to-top {
        display: flex;
      }

      .focus-mode .reading-progress {
        display: block;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .top-nav {
          padding: 0 12px;
        }

        .nav-left, .nav-right {
          gap: 8px;
        }

        .sidebar-toggle,
        .reading-btn,
        .theme-toggle,
        .font-btn {
        width: 40px;
        height: 40px;
          font-size: 16px;
        }

        .page-nav-btn {
          padding: 6px 10px;
          font-size: 12px;
          min-width: 50px;
          height: 40px;
        }

        .lang-btn {
          padding: 6px 12px;
          font-size: 0.9rem;
        }

        .sidebar {
          width: 300px;
          left: -300px;
        }



        .chapter-nav {
          bottom: 10px;
        }

        .chapter-btn {
          padding: 10px 16px;
        }

        .chapter-text {
          display: none;
        }

        .back-to-top {
          bottom: 10px;
          right: 10px;
          width: 45px;
          height: 45px;
          font-size: 1.3rem;
        }

        .focus-mode .main-content {
          padding: 20px;
          margin: 56px 10px 0;
        }
      }

      @media (max-width: 480px) {
        .top-nav {
          height: 48px;
        }

        .main-content {
          margin-top: 48px;
        }

        .sidebar {
          top: 48px;
          height: calc(100vh - 48px);
        }

        .focus-mode .main-content {
          margin-top: 48px;
        }
      }
    </style>

    <script>
      // å…¨å±€çŠ¶æ€ç®¡ç†
      const state = {
        theme: localStorage.getItem('theme') || 'light',
        fontSize: parseInt(localStorage.getItem('fontSize') || '16', 10),
        focusMode: localStorage.getItem('focusMode') === 'true',
        currentBook: '${currentBook}',
        currentChapter: '${currentChapter}'
      };

      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
        initializeTheme();
        initializeFontSize();
        initializeFocusMode();
        initializeSidebar();
        initializeNavigation();
        initializeBackToTop();
        initializeReadingProgress();
        setupKeyboardShortcuts();
      });

      // ä¸»é¢˜ç®¡ç†
      function initializeTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle?.querySelector('.theme-icon');
      
        document.documentElement.setAttribute('data-theme', state.theme);
        if (themeIcon) {
          themeIcon.textContent = state.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        
        themeToggle?.addEventListener('click', () => {
          state.theme = state.theme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', state.theme);
          localStorage.setItem('theme', state.theme);
          
      if (themeIcon) {
            themeIcon.textContent = state.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
          }
        });
      }

      // å­—ä½“å¤§å°ç®¡ç†
      function initializeFontSize() {
        const decreaseFont = document.getElementById('decreaseFont');
        const increaseFont = document.getElementById('increaseFont');
        
        document.body.style.fontSize = state.fontSize + 'px';
        
        decreaseFont?.addEventListener('click', () => {
          if (state.fontSize > 12) {
            state.fontSize -= 2;
            document.body.style.fontSize = state.fontSize + 'px';
            localStorage.setItem('fontSize', state.fontSize.toString());
          }
        });
        
        increaseFont?.addEventListener('click', () => {
          if (state.fontSize < 24) {
            state.fontSize += 2;
            document.body.style.fontSize = state.fontSize + 'px';
            localStorage.setItem('fontSize', state.fontSize.toString());
          }
        });
      }
      
      // ä¸“æ³¨é˜…è¯»æ¨¡å¼
      function initializeFocusMode() {
        const readingModeBtn = document.getElementById('toggleReadingMode');
        
        // åˆå§‹åŒ–æ—¶è®¾ç½®æ­£ç¡®çš„å›¾æ ‡å’ŒçŠ¶æ€
        if (state.focusMode) {
          document.body.classList.add('focus-mode');
          if (readingModeBtn) {
            readingModeBtn.textContent = 'ğŸ“š';
            readingModeBtn.title = 'é€€å‡ºä¸“æ³¨æ¨¡å¼';
          }
          showReadingProgress();
        } else {
          document.body.classList.remove('focus-mode');
          if (readingModeBtn) {
            readingModeBtn.textContent = 'ğŸ“–';
            readingModeBtn.title = 'ä¸“æ³¨é˜…è¯»æ¨¡å¼';
          }
          hideReadingProgress();
        }
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        readingModeBtn?.addEventListener('click', () => {
          document.body.classList.toggle('focus-mode');
          state.focusMode = document.body.classList.contains('focus-mode');
          
          if (readingModeBtn) {
            readingModeBtn.textContent = state.focusMode ? 'ğŸ“š' : 'ğŸ“–';
            readingModeBtn.title = state.focusMode ? 'é€€å‡ºä¸“æ³¨æ¨¡å¼' : 'ä¸“æ³¨é˜…è¯»æ¨¡å¼';
          }
          
          localStorage.setItem('focusMode', state.focusMode.toString());
          
          if (state.focusMode) {
            showReadingProgress();
          } else {
            hideReadingProgress();
          }
        });
      }

      // ä¾§è¾¹æ ç®¡ç†
      function initializeSidebar() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
      
      sidebarToggle?.addEventListener('click', () => {
        sidebar?.classList.toggle('open');
      });
      
        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¾§è¾¹æ 
      document.addEventListener('click', (e) => {
        const target = e.target as Node;
        if (sidebar && sidebarToggle && target &&
            !sidebar.contains(target) && 
            !sidebarToggle.contains(target)) {
          sidebar.classList.remove('open');
          }
        });
        
        // ç”Ÿæˆä¾§è¾¹æ å†…å®¹
        generateSidebarContent();
      }

      // ç”Ÿæˆä¾§è¾¹æ å†…å®¹
      function generateSidebarContent() {
        const sidebarTitle = document.getElementById('sidebarTitle');
        const sidebarNav = document.getElementById('sidebarNav');
        
        if (!sidebarTitle || !sidebarNav) return;
        
        // æ ¹æ®å½“å‰é¡µé¢è·¯å¾„åˆ¤æ–­å½“å‰å†Œå­
        const currentPath = window.location.pathname;
        let currentBook = 'home'; // é»˜è®¤é¦–é¡µ
        
        if (currentPath === '/' || currentPath === '/index.html') {
          currentBook = 'home';
        } else if (currentPath.startsWith('/000_') || currentPath.startsWith('/001_') || 
            currentPath.startsWith('/002_') || currentPath.startsWith('/003_') || 
            currentPath.startsWith('/004_') || currentPath.startsWith('/005_') || 
            currentPath.startsWith('/006_') || currentPath.startsWith('/007_') || 
            currentPath.startsWith('/008_') || currentPath.startsWith('/009_') || 
            currentPath.startsWith('/010_') || currentPath.startsWith('/011_')) {
          currentBook = 'theory';
        } else if (currentPath.includes('/macro')) {
          currentBook = 'macro';
        } else if (currentPath.includes('/stocks')) {
          currentBook = 'stocks';
        } else if (currentPath.includes('/technical')) {
          currentBook = 'technical';
        } else if (currentPath.includes('/quantitative')) {
          currentBook = 'quantitative';
        }
        
        const bookConfigs = {
          home: {
            title: 'ğŸ“š ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†Œ',
            chapters: [
              { number: 'ğŸ“–', title: 'ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒI', url: '/001_Chapter1_Know_Yourself_and_the_World_CN' },
              { number: 'ğŸŒ', title: 'ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒII', url: '/handbook/macro' },
              { number: 'ğŸ”', title: 'ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒIII', url: '/handbook/stocks' },
              { number: 'ğŸ“Š', title: 'ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒIV', url: '/handbook/technical' },
              { number: 'âš¡', title: 'ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒV', url: '/handbook/quantitative' }
            ]
          },
          theory: {
            title: 'ğŸ“– ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒI',
            chapters: [
              { number: 'ğŸ“–', title: 'åºè¨€', url: '/000_Preface_CN' },
              { number: '1ï¸âƒ£', title: 'ç¬¬ä¸€ç« ï¼šæŠ•èµ„è®¤çŸ¥èµ·ç‚¹', url: '/001_Chapter1_Know_Yourself_and_the_World_CN' },
              { number: '2ï¸âƒ£', title: 'ç¬¬äºŒç« ï¼šæŠ•èµ„å¿ƒç†ä¸é£é™©ç®¡ç†', url: '/002_Chapter2_Investment_Psychology_and_Risk_Management_CN' },
              { number: '3ï¸âƒ£', title: 'ç¬¬ä¸‰ç« ï¼šå†å²è§„å¾‹ä¸é«˜å€è‚¡ç ”ç©¶', url: '/003_Chapter3_Historical_Patterns_and_Multibagger_Stocks_CN' },
              { number: '4ï¸âƒ£', title: 'ç¬¬å››ç« ï¼šèµ›é“é€‰æ‹©ä¸è¡Œä¸šè¶‹åŠ¿', url: '/004_Chapter4_Track_Selection_and_Industry_Trends_CN' },
              { number: '5ï¸âƒ£', title: 'ç¬¬äº”ç« ï¼šè‚¡ç¥¨ç­›é€‰ç­–ç•¥', url: '/005_Chapter5_Stock_Screening_Strategies_CN' },
              { number: '6ï¸âƒ£', title: 'ç¬¬å…­ç« ï¼šäº¤æ˜“ç­–ç•¥ä¸æ‰§è¡Œ', url: '/006_Chapter6_Trading_Strategies_and_Execution_CN' },
              { number: '7ï¸âƒ£', title: 'ç¬¬ä¸ƒç« ï¼šæŠ•èµ„å†³ç­–å·¥å…·ä¸èµ„æº', url: '/007_Chapter7_Investment_Decision_Tools_and_Resources_CN' },
              { number: '8ï¸âƒ£', title: 'ç¬¬å…«ç« ï¼šæ¡ˆä¾‹å¤ç›˜ä¸ç­–ç•¥æ”¹è¿›', url: '/008_Chapter8_Case_Review_and_Strategy_Improvement_CN' },
              { number: '9ï¸âƒ£', title: 'ç¬¬ä¹ç« ï¼šæ„å»ºæŠ•èµ„ä½“ç³»', url: '/009_Chapter9_Building_an_Investment_System_CN' },
              { number: 'ğŸ”Ÿ', title: 'ç¬¬åç« ï¼šäº¤æ˜“æ‰§è¡Œä¸å®æˆ˜æŒ‡å—', url: '/010_Chapter10_Trading_Execution_and_Practical_Guide_CN' },
              { number: 'ğŸ“‹', title: 'é™„å½•', url: '/011_Appendix_CN' }
            ]
          },
          macro: {
            title: 'ğŸŒ ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒII',
            chapters: [
              { number: 'ğŸ“–', title: 'å®è§‚ç»æµåˆ†æ', url: '/handbook/macro' }
            ]
          },
          stocks: {
            title: 'ğŸ” ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒIII',
            chapters: [
              { number: 'ğŸ“–', title: 'ä¸ªè‚¡åˆ†æ', url: '/handbook/stocks' }
            ]
          },
          technical: {
            title: 'ğŸ“Š ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒIV',
            chapters: [
              { number: 'ğŸ“–', title: 'æŠ€æœ¯åˆ†æ', url: '/handbook/technical' }
            ]
          },
          quantitative: {
            title: 'âš¡ ç¾è‚¡æŠ•èµ„å®æ“æ‰‹å†ŒV',
            chapters: [
              { number: 'ğŸ“–', title: 'é‡åŒ–åˆ†æ', url: '/handbook/quantitative' }
            ]
          }
        };
        
        const selectedBook = bookConfigs[currentBook] || bookConfigs.home;
        sidebarTitle.textContent = selectedBook.title;
        
        // ç”Ÿæˆå¯¼èˆªé“¾æ¥
        const navHtml = selectedBook.chapters.map(chapter => `
          <a href="${chapter.url}" class="nav-item ${chapter.url === window.location.pathname ? 'active' : ''}">
            <span class="chapter-number">${chapter.number}</span>
            <span class="chapter-title">${chapter.title}</span>
          </a>
        `).join('');
        
        sidebarNav.innerHTML = navHtml;
      }

      // å¯¼èˆªç®¡ç†
      function initializeNavigation() {
        const homeBtn = document.getElementById('homeBtn');
        const tocBtn = document.getElementById('tocBtn');
        const prevChapter = document.getElementById('prevChapter');
        const nextChapter = document.getElementById('nextChapter');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        
        // è¿”å›é¦–é¡µæŒ‰é’®
        homeBtn?.addEventListener('click', () => {
          window.location.href = '/';
        });
        
        // æ™ºèƒ½è¿”å›ç›®å½•æŒ‰é’®
        tocBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const tocUrl = getSmartTocUrl();
          if (tocUrl) {
            window.location.href = tocUrl;
          }
        });
        
        // é¡¶éƒ¨å¯¼èˆªæ ç¿»é¡µæŒ‰é’®
        prevPageBtn?.addEventListener('click', () => {
          navigateToPrevPage();
        });
        
        nextPageBtn?.addEventListener('click', () => {
          navigateToNextPage();
        });
        
        // åˆå§‹åŒ–ç¿»é¡µæŒ‰é’®çŠ¶æ€
        updateNavigationButtons();
        
        // ç« èŠ‚å¯¼èˆª
        if (state.currentBook === 'theory' && state.currentChapter) {
          const chapterNav = document.getElementById('chapterNav');
          if (chapterNav) {
            chapterNav.style.display = 'flex';
            setupChapterNavigation();
          }
        }
      }

      // æ™ºèƒ½è·å–ç›®å½•URL - æ ¹æ®å½“å‰é¡µé¢å±‚çº§è¿”å›ä¸Šä¸€çº§å¯¼èˆªé¡µ
      function getSmartTocUrl() {
        const currentPath = window.location.pathname;
        
        // å¦‚æœåœ¨é¦–é¡µï¼Œè¿”å›é¦–é¡µ
        if (currentPath === '/') {
          return '/';
        }
        
        // å¦‚æœåœ¨å­èŠ‚é¡µé¢ï¼Œè¿”å›ç« èŠ‚å¯¼èˆªé¡µ
        if (currentPath.includes('/001_Chapter1/')) {
          return '/001_Chapter1_Know_Yourself_and_the_World_CN';
        }
        if (currentPath.includes('/002_Chapter2/')) {
          return '/002_Chapter2_Investment_Psychology_and_Risk_Management_CN';
        }
        if (currentPath.includes('/003_Chapter3/')) {
          return '/003_Chapter3_Historical_Patterns_and_Multibagger_Stocks_CN';
        }
        if (currentPath.includes('/004_Chapter4/')) {
          return '/004_Chapter4_Track_Selection_and_Industry_Trends_CN';
        }
        if (currentPath.includes('/005_Chapter5/')) {
          return '/005_Chapter5_Stock_Screening_Strategies_CN';
        }
        if (currentPath.includes('/006_Chapter6/')) {
          return '/006_Chapter6_Trading_Strategies_and_Execution_CN';
        }
        if (currentPath.includes('/007_Chapter7/')) {
          return '/007_Chapter7_Investment_Decision_Tools_and_Resources_CN';
        }
        if (currentPath.includes('/008_Chapter8/')) {
          return '/008_Chapter8_Case_Review_and_Strategy_Improvement_CN';
        }
        if (currentPath.includes('/009_Chapter9/')) {
          return '/009_Chapter9_Building_an_Investment_System_CN';
        }
        if (currentPath.includes('/010_Chapter10/')) {
          return '/010_Chapter10_Trading_Execution_and_Practical_Guide_CN';
        }
        if (currentPath.includes('/011_Appendix/')) {
          return '/011_Appendix_CN';
        }
        
        // å¦‚æœåœ¨ç« èŠ‚å¯¼èˆªé¡µï¼Œè¿”å›æ‰‹å†Œå¯¼èˆªé¡µ
        if (currentPath.startsWith('/001_Chapter') || 
            currentPath.startsWith('/002_Chapter') || 
            currentPath.startsWith('/003_Chapter') || 
            currentPath.startsWith('/004_Chapter') || 
            currentPath.startsWith('/005_Chapter') || 
            currentPath.startsWith('/006_Chapter') || 
            currentPath.startsWith('/007_Chapter') || 
            currentPath.startsWith('/008_Chapter') || 
            currentPath.startsWith('/009_Chapter') || 
            currentPath.startsWith('/010_Chapter') || 
            currentPath.startsWith('/011_Appendix') ||
            currentPath.startsWith('/000_Preface')) {
          return '/handbook/theory';
        }
        
        // å¦‚æœåœ¨æ‰‹å†Œå¯¼èˆªé¡µï¼Œè¿”å›é¦–é¡µ
        if (currentPath.includes('/handbook/')) {
          return '/';
        }
        
        // é»˜è®¤è¿”å›é¦–é¡µ
        return '/';
      }

      // è®¾ç½®ç« èŠ‚å¯¼èˆª
      function setupChapterNavigation() {
        const chapters = [
          '/000_Preface_CN',
          '/001_Chapter1_Know_Yourself_and_the_World_CN',
          '/002_Chapter2_Investment_Psychology_and_Risk_Management_CN',
          '/003_Chapter3_Historical_Patterns_and_Multibagger_Stocks_CN',
          '/004_Chapter4_Track_Selection_and_Industry_Trends_CN',
          '/005_Chapter5_Stock_Screening_Strategies_CN',
          '/006_Chapter6_Trading_Strategies_and_Execution_CN',
          '/007_Chapter7_Investment_Decision_Tools_and_Resources_CN',
          '/008_Chapter8_Case_Review_and_Strategy_Improvement_CN',
          '/009_Chapter9_Building_an_Investment_System_CN',
          '/010_Chapter10_Trading_Execution_and_Practical_Guide_CN',
          '/011_Appendix_CN'
        ];
        
        const currentIndex = chapters.indexOf(window.location.pathname);
        const prevChapter = document.getElementById('prevChapter') as HTMLButtonElement;
        const nextChapter = document.getElementById('nextChapter') as HTMLButtonElement;
        
        if (prevChapter) {
          prevChapter.disabled = currentIndex <= 0;
          if (currentIndex > 0) {
            prevChapter.onclick = () => window.location.href = chapters[currentIndex - 1];
          }
        }
        
        if (nextChapter) {
          nextChapter.disabled = currentIndex >= chapters.length - 1;
          if (currentIndex < chapters.length - 1) {
            nextChapter.onclick = () => window.location.href = chapters[currentIndex + 1];
          }
        }
      }

      // å®Œæ•´çš„é¡µé¢é¡ºåº - åŒ…æ‹¬æ‰€æœ‰å±‚çº§
      function getAllPages() {
        return [
          // 1. é¦–é¡µ
          '/',
          
          // 2. åºè¨€
          '/000_Preface_CN',
          
          // 3. æ‰‹å†ŒIç†è®ºå¯¼èˆªé¡µ
          '/handbook/theory',
          
          // 4. ç¬¬ä¸€ç« å¯¼èˆªé¡µ
          '/001_Chapter1_Know_Yourself_and_the_World_CN',
          
          // 5-7. ç¬¬ä¸€ç« å­èŠ‚
          '/001_Chapter1/1.1_Self_Awareness_and_Investment_Wisdom_CN',
          '/001_Chapter1/1.2_Understanding_the_World_CN',
          '/001_Chapter1/1.3_From_Cognition_to_Action_CN',
          
          // 8. ç¬¬äºŒç« å¯¼èˆªé¡µ
          '/002_Chapter2_Investment_Psychology_and_Risk_Management_CN',
          
          // 9-12. ç¬¬äºŒç« å­èŠ‚
          '/002_Chapter2/2.1_Personalized_Risk_Tolerance_Model_CN',
          '/002_Chapter2/2.2_Stop_Loss_and_Risk_Control_CN',
          '/002_Chapter2/2.3_Investment_Emotions_and_Decision_Traps_CN',
          '/002_Chapter2/2.4_Maintaining_Discipline_in_Volatile_Markets_CN',
          
          // 13. ç¬¬ä¸‰ç« å¯¼èˆªé¡µ
          '/003_Chapter3_Historical_Patterns_and_Multibagger_Stocks_CN',
          
          // 14-17. ç¬¬ä¸‰ç« å­èŠ‚
          '/003_Chapter3/3.1_Definition_and_Time_Dimensions_CN',
          '/003_Chapter3/3.2_Industry_Distribution_and_Characteristics_CN',
          '/003_Chapter3/3.3_Driving_Factors_CN',
          '/003_Chapter3/3.4_Case_Studies_CN',
          
          // 18. ç¬¬å››ç« å¯¼èˆªé¡µ
          '/004_Chapter4_Track_Selection_and_Industry_Trends_CN',
          
          // 19-24. ç¬¬å››ç« å­èŠ‚
          '/004_Chapter4/4.1_Track_Screening_Methods_CN',
          '/004_Chapter4/4.2_AI_and_Big_Data_Revolution_CN',
          '/004_Chapter4/4.3_New_Energy_and_EV_Golden_Decade_CN',
          '/004_Chapter4/4.4_Biotech_and_Precision_Medicine_CN',
          '/004_Chapter4/4.5_Semiconductor_and_Metaverse_CN',
          '/004_Chapter4/4.6_Chinese_Stocks_Opportunities_CN',
          
          // 25. ç¬¬äº”ç« å¯¼èˆªé¡µ
          '/005_Chapter5_Stock_Screening_Strategies_CN',
          
          // 26-31. ç¬¬äº”ç« å­èŠ‚
          '/005_Chapter5/5.1_Stock_Screening_Methods_CN',
          '/005_Chapter5/5.2_Fundamental_Screening_Parameters_CN',
          '/005_Chapter5/5.3_Technical_Analysis_CN',
          '/005_Chapter5/5.4_Valuation_Methodology_CN',
          '/005_Chapter5/5.5_Stock_Screening_Practice_CN',
          '/005_Chapter5/5.6_Derivatives_Enhancement_CN',
          
          // 32. ç¬¬å…­ç« å¯¼èˆªé¡µ
          '/006_Chapter6_Trading_Strategies_and_Execution_CN',
          
          // 33-38. ç¬¬å…­ç« å­èŠ‚
          '/006_Chapter6/6.1_Long_term_vs_Short_term_CN',
          '/006_Chapter6/6.2_Position_Management_CN',
          '/006_Chapter6/6.3_ETF_Optimization_CN',
          '/006_Chapter6/6.4_Dynamic_Adjustment_CN',
          '/006_Chapter6/6.5_Growth_Stock_Exit_CN',
          '/006_Chapter6/6.6_Strategy_Execution_CN',
          
          // 39. ç¬¬ä¸ƒç« å¯¼èˆªé¡µ
          '/007_Chapter7_Investment_Decision_Tools_and_Resources_CN',
          
          // 40-45. ç¬¬ä¸ƒç« å­èŠ‚
          '/007_Chapter7/7.1_GuruFocus_Morningstar_CN',
          '/007_Chapter7/7.2_Technical_Analysis_Tools_CN',
          '/007_Chapter7/7.3_Data_Driven_Decision_CN',
          '/007_Chapter7/7.4_Research_News_Resources_CN',
          '/007_Chapter7/7.5_Broker_Platform_Tools_CN',
          '/007_Chapter7/7.6_ChatGPT_Integration_CN',
          
          // 46. ç¬¬å…«ç« å¯¼èˆªé¡µ
          '/008_Chapter8_Case_Review_and_Strategy_Improvement_CN',
          
          // 47-49. ç¬¬å…«ç« å­èŠ‚
          '/008_Chapter8/8.1_Broadcom_Case_Study_CN',
          '/008_Chapter8/8.2_NVIDIA_Case_Study_CN',
          '/008_Chapter8/8.3_Case_Review_Methodology_CN',
          
          // 50. ç¬¬ä¹ç« å¯¼èˆªé¡µ
          '/009_Chapter9_Building_an_Investment_System_CN',
          
          // 51-53. ç¬¬ä¹ç« å­èŠ‚
          '/009_Chapter9/9.1_Efficient_Investment_Lifestyle_CN',
          '/009_Chapter9/9.2_Strategy_Review_Optimization_CN',
          '/009_Chapter9/9.3_Personal_Investment_System_CN',
          
          // 54. ç¬¬åç« å¯¼èˆªé¡µ
          '/010_Chapter10_Trading_Execution_and_Practical_Guide_CN',
          
          // 55-57. ç¬¬åç« å­èŠ‚
          '/010_Chapter10/10.1_Preparation_CN',
          '/010_Chapter10/10.2_Gurufocus_Screening_CN',
          '/010_Chapter10/10.3_Trading_Execution_CN',
          
          // 58. é™„å½•å¯¼èˆªé¡µ
          '/011_Appendix_CN',
          
          // 59-68. é™„å½•å­èŠ‚
          '/011_Appendix/A.1_Financial_Indicators_and_Formulas_CN',
          '/011_Appendix/B.1_Recommended_Reading_List_CN',
          '/011_Appendix/C.1_Quantitative_Analysis_and_Backtesting_CN',
          '/011_Appendix/D.1_Trading_Plan_Templates_CN',
          '/011_Appendix/E.1_Broker_Platform_Guide_CN',
          '/011_Appendix/F.1_GuruFocus_Plus_Case_Study_CN',
          '/011_Appendix/G.1_Charlie_Munger_Wisdom_CN',
          '/011_Appendix/H.1_Intelligent_Trading_System_CN',
          '/011_Appendix/I.1_US_Stock_Investment_FAQ_CN',
          '/011_Appendix/J.1_Document_System_Construction_Guide_CN',
          
          // 69-72. å…¶ä»–æ‰‹å†Œå¯¼èˆªé¡µ
          '/handbook/macro',
          '/handbook/stocks', 
          '/handbook/technical',
          '/handbook/quantitative'
        ];
      }

      // ç¿»é¡µåŠŸèƒ½
      function navigateToPrevPage() {
        const pages = getAllPages();
        const currentPath = window.location.pathname;
        const currentIndex = pages.indexOf(currentPath);
        
        if (currentIndex > 0) {
          window.location.href = pages[currentIndex - 1];
        }
      }

      function navigateToNextPage() {
        const pages = getAllPages();
        const currentPath = window.location.pathname;
        const currentIndex = pages.indexOf(currentPath);
        
        if (currentIndex >= 0 && currentIndex < pages.length - 1) {
          window.location.href = pages[currentIndex + 1];
        }
      }

      // æ›´æ–°ç¿»é¡µæŒ‰é’®çŠ¶æ€
      function updateNavigationButtons() {
        const pages = getAllPages();
        const currentPath = window.location.pathname;
        const currentIndex = pages.indexOf(currentPath);
        
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        
        if (prevBtn && nextBtn) {
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          prevBtn.disabled = currentIndex <= 0;
          nextBtn.disabled = currentIndex >= pages.length - 1;
          
          // æ›´æ–°æŒ‰é’®æ–‡å­—æ˜¾ç¤ºé¡µé¢ä¿¡æ¯
          if (currentIndex > 0) {
            prevBtn.title = `ä¸Šä¸€é¡µ`;
          } else {
            prevBtn.title = 'å·²æ˜¯ç¬¬ä¸€é¡µ';
          }
          
          if (currentIndex < pages.length - 1) {
            nextBtn.title = `ä¸‹ä¸€é¡µ`;
          } else {
            nextBtn.title = 'å·²æ˜¯æœ€åä¸€é¡µ';
          }
        }
      }

      // å›åˆ°é¡¶éƒ¨
      function initializeBackToTop() {
      const backToTopBtn = document.getElementById('backToTop');
        
        window.addEventListener('scroll', () => {
          if (backToTopBtn) {
          if (window.scrollY > 300) {
            backToTopBtn.style.display = 'flex';
          } else {
            backToTopBtn.style.display = 'none';
            }
          }
        });
        
        backToTopBtn?.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      // é˜…è¯»è¿›åº¦
      function initializeReadingProgress() {
        if (state.focusMode) {
          showReadingProgress();
        }
      }

      function showReadingProgress() {
        const progress = document.getElementById('readingProgress');
        if (progress) {
          progress.style.display = 'block';
          window.addEventListener('scroll', updateReadingProgress);
        }
      }

      function hideReadingProgress() {
        const progress = document.getElementById('readingProgress');
        if (progress) {
          progress.style.display = 'none';
          window.removeEventListener('scroll', updateReadingProgress);
        }
      }
      
      function updateReadingProgress() {
        const progressBar = document.getElementById('readingProgressBar');
        if (!progressBar) return;
        
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        
        progressBar.style.width = scrollPercent + '%';
      }

      // é”®ç›˜å¿«æ·é”®
      function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          // ESC: é€€å‡ºä¸“æ³¨æ¨¡å¼
          if (e.key === 'Escape' && state.focusMode) {
            document.getElementById('toggleReadingMode')?.click();
          }
          
          // Ctrl/Cmd + +/-: è°ƒæ•´å­—ä½“
          if ((e.ctrlKey || e.metaKey) && e.key === '=') {
            e.preventDefault();
            document.getElementById('increaseFont')?.click();
          }
          if ((e.ctrlKey || e.metaKey) && e.key === '-') {
            e.preventDefault();
            document.getElementById('decreaseFont')?.click();
          }
          
          // Ctrl/Cmd + D: åˆ‡æ¢ä¸»é¢˜
          if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            document.getElementById('themeToggle')?.click();
          }
        });
      }
    </script>
  </body>
</html> 