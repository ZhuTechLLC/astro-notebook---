---
export interface Props {
  title: string;
  lang?: string;
  alt?: string;
  currentBook?: string;
  currentChapter?: string;
}

const { title, lang = 'zh-CN', alt = '', currentBook = 'theory', currentChapter = '' } = Astro.props;
const isEn = lang === 'en' || (typeof window !== 'undefined' && window.location.pathname.startsWith('/en/'));
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="美股投资实操手册 - 完整知识体系" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
  </head>
  <body>
    <div class="container">
      <!-- 顶部导航栏 -->
      <header class="top-nav" id="topNav">
        <div class="nav-left">
          <button class="sidebar-toggle" id="sidebarToggle" aria-label="切换侧边栏">📚</button>
        </div>
        <div class="nav-right">
          <button id="toggleReadingMode" class="reading-btn" title="专注阅读模式">📖</button>
          <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
            <span class="theme-icon">🌙</span>
          </button>
          <button id="decreaseFont" class="font-btn" title="缩小字体">A-</button>
          <button id="increaseFont" class="font-btn" title="放大字体">A+</button>
          <a class="lang-btn" id="langSwitchEn" href={alt} title="English">EN</a>
          <a class="lang-btn" id="langSwitchCn" href={alt} title="中文">CN</a>
        </div>
      </header>

      <!-- 阅读进度条（专注模式显示） -->
      <div class="reading-progress" id="readingProgress" style="display: none;">
        <div class="reading-progress-bar" id="readingProgressBar"></div>
      </div>
      
      <!-- 侧边栏 -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2 id="sidebarTitle">📈 美股投资实操手册</h2>
        </div>
        
        <nav class="sidebar-nav" id="sidebarNav">
          <!-- 动态生成导航内容 -->
        </nav>
      </aside>

      <!-- 主内容区 -->
      <main class="main-content" id="mainContent">
        <slot />
      </main>

      <!-- 左侧空间导航按钮 -->
      <div class="left-nav" id="leftNav">
        <a href="/" class="nav-btn home-btn" title="返回首页">
          <span class="nav-icon">🏠</span>
          <span class="nav-text">返回首页</span>
        </a>
        <a href="#" class="nav-btn toc-btn" id="tocBtn" title="返回目录">
          <span class="nav-icon">📚</span>
          <span class="nav-text">返回目录</span>
        </a>
        <button class="nav-btn back-btn" id="backBtn" title="上一页">
          <span class="nav-icon">←</span>
          <span class="nav-text">上一页</span>
        </button>
      </div>

      <!-- 章节导航（仅book1章节页面显示） -->
      <div class="chapter-nav" id="chapterNav" style="display: none;">
        <button class="chapter-btn prev-chapter" id="prevChapter" disabled>
          <span class="chapter-icon">←</span>
          <span class="chapter-text">上一章</span>
        </button>
        <button class="chapter-btn next-chapter" id="nextChapter">
          <span class="chapter-text">下一章</span>
          <span class="chapter-icon">→</span>
        </button>
      </div>

      <!-- 回到顶部按钮 -->
      <button id="backToTop" class="back-to-top" aria-label="回到顶部" style="display: none;">↑</button>
    </div>

    <style is:global>
      @import '../styles/style.css';

      /* 容器 */
      .container {
        position: relative;
        min-height: 100vh;
      }

      /* 顶部导航栏 */
      .top-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 16px;
        height: 56px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1100;
        transition: all 0.3s ease;
      }

      .nav-left, .nav-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* 按钮基础样式 */
      .sidebar-toggle,
      .reading-btn,
      .theme-toggle,
      .font-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .sidebar-toggle:hover,
      .reading-btn:hover,
      .theme-toggle:hover,
      .font-btn:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }

      /* 语言切换按钮 */
      .lang-btn {
        padding: 8px 16px;
        border-radius: 20px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
      }

      .lang-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
      }

      /* 阅读进度条 */
      .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--bg-secondary);
        z-index: 1200;
      }

      .reading-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        width: 0%;
        transition: width 0.3s ease;
      }

      /* 侧边栏 */
      .sidebar {
        position: fixed;
        top: 56px;
        left: -300px;
        width: 300px;
        height: calc(100vh - 56px);
        background: var(--bg-primary);
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        transition: left 0.3s ease;
        z-index: 1000;
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .sidebar-header h2 {
        margin: 0;
        color: var(--primary-dark);
        font-size: 1.2rem;
      }

      .sidebar-nav {
        padding: 20px 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }

      .nav-item:hover {
        background: var(--bg-secondary);
        border-left-color: var(--primary-color);
        color: var(--primary-color);
      }

      .nav-item.active {
        background: var(--primary-color);
        color: white;
        border-left-color: var(--primary-dark);
      }

      .chapter-number {
        margin-right: 12px;
        font-size: 1.1rem;
      }

      .chapter-title {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      /* 主内容区 */
      .main-content {
        margin-top: 56px;
        padding: 20px;
        transition: margin-left 0.3s ease;
        min-height: calc(100vh - 56px);
      }

      .main-content.sidebar-open {
        margin-left: 300px;
      }

      /* 左侧空间导航 */
      .left-nav {
        position: fixed;
        left: 20px;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 900;
      }

      .nav-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 25px;
        text-decoration: none;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
        cursor: pointer;
      }

      .home-btn {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
      }

      .toc-btn {
        background: linear-gradient(135deg, #ff9800, #ffb74d);
      }

      .back-btn {
        background: linear-gradient(135deg, #2196f3, #42a5f5);
      }

      .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }

      .nav-icon {
        font-size: 1.2rem;
      }

      .nav-text {
        font-size: 0.9rem;
      }

      /* 章节导航 */
      .chapter-nav {
        position: fixed;
        top: 70px; /* 56px nav + margin */
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 900;
      }

      .chapter-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 25px;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .chapter-btn:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }

      .chapter-btn:disabled {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: not-allowed;
        opacity: 0.6;
      }

      .chapter-icon {
        font-size: 1.1rem;
      }

      .chapter-text {
        font-size: 0.9rem;
      }

      /* 回到顶部按钮 */
      .back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 900;
      }

      .back-to-top:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }

      /* 专注阅读模式 */
      .focus-mode .top-nav {
        background: transparent;
        border: none;
        box-shadow: none;
      }

      .focus-mode .top-nav .nav-left {
        display: none;
      }

      .focus-mode .top-nav .nav-right {
        display: flex;
        gap: 12px;
      }

      .focus-mode .top-nav .reading-btn,
      .focus-mode .top-nav .theme-toggle {
        display: flex;
      }

      .focus-mode .top-nav .font-btn,
      .focus-mode .top-nav .lang-btn {
        display: none;
      }

      .focus-mode .sidebar {
        display: none;
      }

      .focus-mode .main-content {
        margin-left: 0;
        max-width: 800px;
        margin: 56px auto 0;
        padding: 40px;
      }

      .focus-mode .left-nav,
      .focus-mode .chapter-nav,
      .focus-mode .back-to-top {
        display: none;
      }

      .focus-mode .reading-progress {
        display: block;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .top-nav {
          padding: 0 12px;
        }

        .nav-left, .nav-right {
          gap: 8px;
        }

        .sidebar-toggle,
        .reading-btn,
        .theme-toggle,
        .font-btn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }

        .lang-btn {
          padding: 6px 12px;
          font-size: 0.9rem;
        }

        .sidebar {
          width: 280px;
          left: -280px;
        }

        .main-content.sidebar-open {
          margin-left: 280px;
        }

        .left-nav {
          left: 10px;
          bottom: 10px;
        }

        .nav-btn {
          padding: 10px 12px;
        }

        .nav-text {
          display: none;
        }

        .chapter-nav {
          bottom: 10px;
        }

        .chapter-btn {
          padding: 10px 16px;
        }

        .chapter-text {
          display: none;
        }

        .back-to-top {
          bottom: 10px;
          right: 10px;
          width: 45px;
          height: 45px;
          font-size: 1.3rem;
        }

        .focus-mode .main-content {
          padding: 20px;
          margin: 56px 10px 0;
        }
      }

      @media (max-width: 480px) {
        .top-nav {
          height: 48px;
        }

        .main-content {
          margin-top: 48px;
        }

        .sidebar {
          top: 48px;
          height: calc(100vh - 48px);
        }

        .focus-mode .main-content {
          margin-top: 48px;
        }
      }
    </style>

    <script>
      // 全局状态管理
      const state = {
        theme: localStorage.getItem('theme') || 'light',
        fontSize: parseInt(localStorage.getItem('fontSize') || '16', 10),
        focusMode: localStorage.getItem('focusMode') === 'true',
        currentBook: '${currentBook}',
        currentChapter: '${currentChapter}'
      };

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
        initializeTheme();
        initializeFontSize();
        initializeFocusMode();
        initializeSidebar();
        initializeNavigation();
        initializeBackToTop();
        initializeReadingProgress();
        setupKeyboardShortcuts();
      });

      // 主题管理
      function initializeTheme() {
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle?.querySelector('.theme-icon');
        
        document.documentElement.setAttribute('data-theme', state.theme);
        if (themeIcon) {
          themeIcon.textContent = state.theme === 'dark' ? '☀️' : '🌙';
        }
        
        themeToggle?.addEventListener('click', () => {
          state.theme = state.theme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', state.theme);
          localStorage.setItem('theme', state.theme);
          
          if (themeIcon) {
            themeIcon.textContent = state.theme === 'dark' ? '☀️' : '🌙';
          }
        });
      }

      // 字体大小管理
      function initializeFontSize() {
        const decreaseFont = document.getElementById('decreaseFont');
        const increaseFont = document.getElementById('increaseFont');
        
        document.body.style.fontSize = state.fontSize + 'px';
        
        decreaseFont?.addEventListener('click', () => {
          if (state.fontSize > 12) {
            state.fontSize -= 2;
            document.body.style.fontSize = state.fontSize + 'px';
            localStorage.setItem('fontSize', state.fontSize.toString());
          }
        });
        
        increaseFont?.addEventListener('click', () => {
          if (state.fontSize < 24) {
            state.fontSize += 2;
            document.body.style.fontSize = state.fontSize + 'px';
            localStorage.setItem('fontSize', state.fontSize.toString());
          }
        });
      }

      // 专注阅读模式
      function initializeFocusMode() {
        const readingModeBtn = document.getElementById('toggleReadingMode');
        
        if (state.focusMode) {
          document.body.classList.add('focus-mode');
          if (readingModeBtn) {
            readingModeBtn.textContent = '📚';
            readingModeBtn.title = '退出专注模式';
          }
        }
        
        readingModeBtn?.addEventListener('click', () => {
          document.body.classList.toggle('focus-mode');
          state.focusMode = document.body.classList.contains('focus-mode');
          
          if (readingModeBtn) {
            readingModeBtn.textContent = state.focusMode ? '📚' : '📖';
            readingModeBtn.title = state.focusMode ? '退出专注模式' : '专注阅读模式';
          }
          
          localStorage.setItem('focusMode', state.focusMode.toString());
          
          if (state.focusMode) {
            showReadingProgress();
          } else {
            hideReadingProgress();
          }
        });
      }

      // 侧边栏管理
      function initializeSidebar() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
      
      sidebarToggle?.addEventListener('click', () => {
        sidebar?.classList.toggle('open');
        mainContent?.classList.toggle('sidebar-open');
      });
      
        // 点击外部关闭侧边栏
      document.addEventListener('click', (e) => {
        const target = e.target as Node;
        if (sidebar && sidebarToggle && target &&
            !sidebar.contains(target) && 
            !sidebarToggle.contains(target)) {
          sidebar.classList.remove('open');
          mainContent?.classList.remove('sidebar-open');
        }
      });
      
        // 生成侧边栏内容
        generateSidebarContent();
      }

      // 生成侧边栏内容
      function generateSidebarContent() {
        const sidebarTitle = document.getElementById('sidebarTitle');
        const sidebarNav = document.getElementById('sidebarNav');
        
        if (!sidebarTitle || !sidebarNav) return;
        
        const bookConfigs = {
          theory: {
            title: '📖 第一册：理论手册',
            chapters: [
              { number: '📖', title: '序言', url: '/000_Preface_CN' },
              { number: '1️⃣', title: '第一章：投资认知起点', url: '/001_Chapter1_Know_Yourself_and_the_World_CN' },
              { number: '2️⃣', title: '第二章：投资心理与风险管理', url: '/002_Chapter2_Investment_Psychology_and_Risk_Management_CN' },
              { number: '3️⃣', title: '第三章：历史规律与高倍股研究', url: '/003_Chapter3_Historical_Patterns_and_Multibagger_Stocks_CN' },
              { number: '4️⃣', title: '第四章：赛道选择与行业趋势', url: '/004_Chapter4_Track_Selection_and_Industry_Trends_CN' },
              { number: '5️⃣', title: '第五章：股票筛选策略', url: '/005_Chapter5_Stock_Screening_Strategies_CN' },
              { number: '6️⃣', title: '第六章：交易策略与执行', url: '/006_Chapter6_Trading_Strategies_and_Execution_CN' },
              { number: '7️⃣', title: '第七章：投资决策工具与资源', url: '/007_Chapter7_Investment_Decision_Tools_and_Resources_CN' },
              { number: '8️⃣', title: '第八章：案例复盘与策略改进', url: '/008_Chapter8_Case_Review_and_Strategy_Improvement_CN' },
              { number: '9️⃣', title: '第九章：构建投资体系', url: '/009_Chapter9_Building_Investment_System_CN' },
              { number: '🔟', title: '第十章：交易执行与实战指南', url: '/010_Chapter10_Trading_Execution_and_Practical_Guide_CN' },
              { number: '📋', title: '附录', url: '/011_Appendix_CN' }
            ]
          },
          macro: {
            title: '🌍 第二册：宏观经济',
            chapters: [
              { number: '📖', title: '宏观经济分析', url: '/handbook/macro' }
            ]
          },
          stocks: {
            title: '🔍 第三册：个股研究',
            chapters: [
              { number: '📖', title: '个股分析', url: '/handbook/stocks' }
            ]
          },
          technical: {
            title: '📊 第四册：技术分析',
            chapters: [
              { number: '📖', title: '技术分析', url: '/handbook/technical' }
            ]
          },
          quantitative: {
            title: '⚡ 第五册：量化专题',
            chapters: [
              { number: '📖', title: '量化分析', url: '/handbook/quantitative' }
            ]
          }
        };
        
        const currentBook = bookConfigs[state.currentBook] || bookConfigs.theory;
        sidebarTitle.textContent = currentBook.title;
        
        // 生成导航链接
        const navHtml = currentBook.chapters.map(chapter => `
          <a href="${chapter.url}" class="nav-item ${chapter.url === window.location.pathname ? 'active' : ''}">
            <span class="chapter-number">${chapter.number}</span>
            <span class="chapter-title">${chapter.title}</span>
          </a>
        `).join('');
        
        sidebarNav.innerHTML = navHtml;
      }

      // 导航管理
      function initializeNavigation() {
        const tocBtn = document.getElementById('tocBtn');
        const backBtn = document.getElementById('backBtn');
        const prevChapter = document.getElementById('prevChapter');
        const nextChapter = document.getElementById('nextChapter');
        
        // 返回目录按钮
        tocBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const tocUrl = getTocUrl();
          if (tocUrl) {
            window.location.href = tocUrl;
          }
        });
        
        // 上一页按钮
        backBtn?.addEventListener('click', () => {
          window.history.back();
        });
        
        // 章节导航
        if (state.currentBook === 'theory' && state.currentChapter) {
          const chapterNav = document.getElementById('chapterNav');
          if (chapterNav) {
            chapterNav.style.display = 'flex';
            setupChapterNavigation();
          }
        }
      }

      // 获取目录URL
      function getTocUrl() {
        const bookUrls = {
          theory: '/handbook/theory',
          macro: '/handbook/macro',
          stocks: '/handbook/stocks',
          technical: '/handbook/technical',
          quantitative: '/handbook/quantitative'
        };
        return bookUrls[state.currentBook] || '/';
      }

      // 设置章节导航
      function setupChapterNavigation() {
        const chapters = [
          '/000_Preface_CN',
          '/001_Chapter1_Know_Yourself_and_the_World_CN',
          '/002_Chapter2_Investment_Psychology_and_Risk_Management_CN',
          '/003_Chapter3_Historical_Patterns_and_Multibagger_Stocks_CN',
          '/004_Chapter4_Track_Selection_and_Industry_Trends_CN',
          '/005_Chapter5_Stock_Screening_Strategies_CN',
          '/006_Chapter6_Trading_Strategies_and_Execution_CN',
          '/007_Chapter7_Investment_Decision_Tools_and_Resources_CN',
          '/008_Chapter8_Case_Review_and_Strategy_Improvement_CN',
          '/009_Chapter9_Building_Investment_System_CN',
          '/010_Chapter10_Trading_Execution_and_Practical_Guide_CN',
          '/011_Appendix_CN'
        ];
        
        const currentIndex = chapters.indexOf(window.location.pathname);
        const prevChapter = document.getElementById('prevChapter') as HTMLButtonElement;
        const nextChapter = document.getElementById('nextChapter') as HTMLButtonElement;
        
        if (prevChapter) {
          prevChapter.disabled = currentIndex <= 0;
          if (currentIndex > 0) {
            prevChapter.onclick = () => window.location.href = chapters[currentIndex - 1];
          }
        }
        
        if (nextChapter) {
          nextChapter.disabled = currentIndex >= chapters.length - 1;
          if (currentIndex < chapters.length - 1) {
            nextChapter.onclick = () => window.location.href = chapters[currentIndex + 1];
          }
        }
      }

      // 回到顶部
      function initializeBackToTop() {
        const backToTopBtn = document.getElementById('backToTop');
        
        window.addEventListener('scroll', () => {
          if (backToTopBtn) {
            if (window.scrollY > 300) {
              backToTopBtn.style.display = 'flex';
            } else {
              backToTopBtn.style.display = 'none';
            }
          }
        });
        
        backToTopBtn?.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      // 阅读进度
      function initializeReadingProgress() {
        if (state.focusMode) {
          showReadingProgress();
        }
      }

      function showReadingProgress() {
        const progress = document.getElementById('readingProgress');
        if (progress) {
          progress.style.display = 'block';
          window.addEventListener('scroll', updateReadingProgress);
        }
      }

      function hideReadingProgress() {
        const progress = document.getElementById('readingProgress');
        if (progress) {
          progress.style.display = 'none';
          window.removeEventListener('scroll', updateReadingProgress);
        }
      }
      
      function updateReadingProgress() {
        const progressBar = document.getElementById('readingProgressBar');
        if (!progressBar) return;
        
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        
        progressBar.style.width = scrollPercent + '%';
      }

      // 键盘快捷键
      function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          // ESC: 退出专注模式
          if (e.key === 'Escape' && state.focusMode) {
            document.getElementById('toggleReadingMode')?.click();
          }
          
          // Ctrl/Cmd + +/-: 调整字体
          if ((e.ctrlKey || e.metaKey) && e.key === '=') {
            e.preventDefault();
            document.getElementById('increaseFont')?.click();
          }
          if ((e.ctrlKey || e.metaKey) && e.key === '-') {
            e.preventDefault();
            document.getElementById('decreaseFont')?.click();
          }
          
          // Ctrl/Cmd + D: 切换主题
          if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            document.getElementById('themeToggle')?.click();
          }
        });
      }
    </script>

    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        /* Self Reflection Form Handling */
        const form = document.querySelector('.self-reflection-form');
        if (form) {
          const questions = form.querySelectorAll('.form-question');
          questions.forEach((q, idx) => {
            const answerSpace = q.querySelector('.answer-space');
            if (answerSpace) {
              const key = `self_reflection_q${idx + 1}`;
              const textarea = document.createElement('textarea');
              textarea.rows = 3;
              textarea.placeholder = '示例：请在此填写你的答案';
              textarea.style.width = '100%';
              textarea.style.padding = '10px';
              textarea.style.border = '1px solid var(--border-color)';
              textarea.style.borderRadius = '8px';
              textarea.style.background = 'var(--bg-secondary)';
              textarea.style.color = 'var(--text-primary)';
              // load saved value
              const saved = localStorage.getItem(key);
              if (saved) textarea.value = saved;
              answerSpace.replaceWith(textarea);
            }
          });
          // Append action buttons
          const actionWrapper = document.createElement('div');
          actionWrapper.style.marginTop = '20px';
          actionWrapper.style.display = 'flex';
          actionWrapper.style.gap = '12px';

          const saveBtn = document.createElement('button');
          saveBtn.textContent = '保存';
          saveBtn.className = 'form-action-btn';
          const resetBtn = document.createElement('button');
          resetBtn.textContent = '清空';
          resetBtn.className = 'form-action-btn';

          actionWrapper.appendChild(saveBtn);
          actionWrapper.appendChild(resetBtn);
          form.appendChild(actionWrapper);

          saveBtn.addEventListener('click', () => {
            questions.forEach((q, idx) => {
              const ta = q.querySelector('textarea');
              if (ta) {
                localStorage.setItem(`self_reflection_q${idx + 1}`, ta.value);
              }
            });
            alert('已保存至本地浏览器！');
          });

          resetBtn.addEventListener('click', () => {
            if (!confirm('确定要清空所有回答？')) return;
            questions.forEach((q, idx) => {
              const ta = q.querySelector('textarea');
              if (ta) {
                ta.value = '';
                localStorage.removeItem(`self_reflection_q${idx + 1}`);
              }
            });
          });
        }
      });
    </script>
  </body>
</html> 