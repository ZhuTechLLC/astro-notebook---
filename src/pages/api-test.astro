---
import Layout from '../layouts/Layout.astro';
---

<Layout title="é‡‘èæœ¯è¯­APIæµ‹è¯•">
  <div class="container">
    <h1>é‡‘èæœ¯è¯­APIæµ‹è¯•</h1>
    
    <div class="test-panel">
      <h2>APIåŠŸèƒ½æµ‹è¯•</h2>
      
      <div class="test-controls">
        <input type="text" id="termInput" placeholder="è¾“å…¥é‡‘èæœ¯è¯­" value="Bitcoin">
        <button onclick="testSingleTerm()">æµ‹è¯•å•ä¸ªæœ¯è¯­</button>
        <button onclick="testBatchTerms()">æ‰¹é‡æµ‹è¯•</button>
        <button onclick="testCache()">æŸ¥çœ‹ç¼“å­˜</button>
      </div>
      
      <div id="results" class="results-panel">
        <p>ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
      </div>
    </div>

    <div class="glossary-demo">
      <h2>æ‚¬æµ®æç¤ºæ¼”ç¤º</h2>
      <p>
        æµ‹è¯•ä»¥ä¸‹æœ¯è¯­çš„æ‚¬æµ®æç¤ºåŠŸèƒ½ï¼š
        <span class="glossary-term" data-term="Bitcoin" data-definition='{"term":"Bitcoin","fullName":"Bitcoin","description":"ç¬¬ä¸€ä¸ªå»ä¸­å¿ƒåŒ–åŠ å¯†è´§å¸ï¼Œç”±ä¸­æœ¬èªåœ¨2009å¹´åˆ›å»º","category":"åŠ å¯†è´§å¸","example":"æ¯”ç‰¹å¸æ€»ä¾›åº”é‡2100ä¸‡æšï¼Œé€šè¿‡æŒ–çŸ¿äº§ç”Ÿ"}' title="ç¬¬ä¸€ä¸ªå»ä¸­å¿ƒåŒ–åŠ å¯†è´§å¸ï¼Œç”±ä¸­æœ¬èªåœ¨2009å¹´åˆ›å»º">Bitcoin</span>ã€
        <span class="glossary-term" data-term="NASDAQ" data-definition='{"term":"NASDAQ","fullName":"NASDAQ","description":"çº³æ–¯è¾¾å…‹è¯åˆ¸äº¤æ˜“æ‰€ï¼Œä¸»è¦äº¤æ˜“ç§‘æŠ€è‚¡","category":"äº¤æ˜“æ‰€","example":"è‹¹æœã€å¾®è½¯ã€è°·æ­Œç­‰ç§‘æŠ€å·¨å¤´åœ¨çº³æ–¯è¾¾å…‹ä¸Šå¸‚"}' title="çº³æ–¯è¾¾å…‹è¯åˆ¸äº¤æ˜“æ‰€ï¼Œä¸»è¦äº¤æ˜“ç§‘æŠ€è‚¡">NASDAQ</span>ã€
        <span class="glossary-term" data-term="PE" data-definition='{"term":"PE","fullName":"Price-to-Earnings Ratio","description":"å¸‚ç›ˆç‡ï¼Œè‚¡ä»·ä¸æ¯è‚¡æ”¶ç›Šçš„æ¯”ç‡ï¼Œè¡¡é‡è‚¡ç¥¨ä¼°å€¼æ°´å¹³","category":"ä¼°å€¼æŒ‡æ ‡","example":"PE = è‚¡ä»· / æ¯è‚¡æ”¶ç›Šï¼Œé€šå¸¸15-25å€ä¸ºåˆç†åŒºé—´"}' title="å¸‚ç›ˆç‡ï¼Œè‚¡ä»·ä¸æ¯è‚¡æ”¶ç›Šçš„æ¯”ç‡ï¼Œè¡¡é‡è‚¡ç¥¨ä¼°å€¼æ°´å¹³">PE</span>
      </p>
    </div>
  </div>
</Layout>

<style>
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
  }

  .test-panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    margin: 2rem 0;
  }

  .test-controls {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    flex-wrap: wrap;
  }

  .test-controls input {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  .test-controls button {
    padding: 0.5rem 1rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .test-controls button:hover {
    background: var(--primary-dark);
  }

  .results-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 1rem;
    margin-top: 1rem;
    min-height: 100px;
    font-family: monospace;
    white-space: pre-wrap;
  }

  .glossary-demo {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    margin: 2rem 0;
  }

  .glossary-term {
    color: var(--primary-color);
    font-weight: 600;
    cursor: help;
    border-bottom: 1px dotted var(--primary-color);
    transition: all 0.2s ease;
  }

  .glossary-term:hover {
    background: var(--primary-color);
    color: white;
    border-bottom-color: transparent;
  }

  .tooltip {
    position: absolute;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .tooltip-header {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .tooltip-category {
    display: inline-block;
    background: var(--primary-color);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
  }

  .tooltip-description {
    margin-bottom: 0.5rem;
  }

  .tooltip-example {
    font-style: italic;
    color: var(--text-secondary);
    font-size: 0.85rem;
  }

  @media (max-width: 768px) {
    .test-controls {
      flex-direction: column;
    }
    
    .test-controls input,
    .test-controls button {
      width: 100%;
    }
  }
</style>

<script>
  // é‡‘èæœ¯è¯­APIæµ‹è¯•åŠŸèƒ½
  let currentTooltip = null; // å…¨å±€å˜é‡è·Ÿè¸ªå½“å‰æ˜¾ç¤ºçš„æç¤ºæ¡†
  
  document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–å·¥å…·æç¤º
    initTooltips();
    
    // ç»‘å®šæµ‹è¯•å‡½æ•°åˆ°å…¨å±€
    window.testSingleTerm = testSingleTerm;
    window.testBatchTerms = testBatchTerms;
    window.testCache = testCache;
  });

  // åˆå§‹åŒ–å·¥å…·æç¤º
  function initTooltips() {
    const glossaryTerms = document.querySelectorAll('.glossary-term');
    
    glossaryTerms.forEach(term => {
      term.addEventListener('mouseenter', showTooltip);
      term.addEventListener('mouseleave', hideTooltip);
    });
  }

  // æ˜¾ç¤ºå·¥å…·æç¤º
  function showTooltip(event) {
    const term = event.target;
    const definition = term.getAttribute('data-definition');
    
    if (!definition) return;

    // å¦‚æœå·²æœ‰æç¤ºæ¡†ï¼Œå…ˆç§»é™¤
    if (currentTooltip) {
      currentTooltip.remove();
      currentTooltip = null;
    }

    try {
      const data = JSON.parse(definition);
      
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      tooltip.innerHTML = `
        <div class="tooltip-header">${data.fullName || data.term}</div>
        <div class="tooltip-category">${data.category}</div>
        <div class="tooltip-description">${data.description}</div>
        ${data.example ? `<div class="tooltip-example">ç¤ºä¾‹ï¼š${data.example}</div>` : ''}
      `;

      const rect = term.getBoundingClientRect();
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.bottom + 10) + 'px';

      document.body.appendChild(tooltip);
      currentTooltip = tooltip;

      // è°ƒæ•´ä½ç½®é¿å…è¶…å‡ºè§†çª—
      setTimeout(() => {
        const tooltipRect = tooltip.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        if (tooltipRect.right > viewportWidth) {
          tooltip.style.left = (viewportWidth - tooltipRect.width - 10) + 'px';
        }

        if (tooltipRect.bottom > viewportHeight) {
          tooltip.style.top = (rect.top - tooltipRect.height - 10) + 'px';
        }
      }, 0);

    } catch (error) {
      console.warn('Failed to parse tooltip data:', error);
    }
  }

  // éšè—å·¥å…·æç¤º
  function hideTooltip(event) {
    // å»¶è¿Ÿç§»é™¤ï¼Œé¿å…é¼ æ ‡ç§»åŠ¨åˆ°æç¤ºæ¡†æ—¶ç«‹å³æ¶ˆå¤±
    setTimeout(() => {
      if (currentTooltip && !currentTooltip.matches(':hover')) {
        currentTooltip.remove();
        currentTooltip = null;
      }
    }, 100);
  }

  // æµ‹è¯•å•ä¸ªæœ¯è¯­
  async function testSingleTerm() {
    const term = document.getElementById('termInput').value.trim();
    if (!term) {
      updateResults('è¯·è¾“å…¥è¦æµ‹è¯•çš„æœ¯è¯­');
      return;
    }

    updateResults(`æ­£åœ¨æµ‹è¯•æœ¯è¯­: ${term}...`);
    
    try {
      // æ¨¡æ‹ŸAPIè°ƒç”¨
      const result = await simulateAPICall(term);
      updateResults(`âœ… æµ‹è¯•å®Œæˆ\n\næœ¯è¯­: ${result.term}\nå…¨å: ${result.fullName}\nåˆ†ç±»: ${result.category}\næè¿°: ${result.description}\nç¤ºä¾‹: ${result.example}`);
    } catch (error) {
      updateResults(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  }

  // æ‰¹é‡æµ‹è¯•
  async function testBatchTerms() {
    const terms = ['Bitcoin', 'NASDAQ', 'PE', 'ROE', 'ETF'];
    updateResults(`æ­£åœ¨æ‰¹é‡æµ‹è¯• ${terms.length} ä¸ªæœ¯è¯­...`);
    
    try {
      const results = [];
      for (const term of terms) {
        const result = await simulateAPICall(term);
        results.push(`${term}: ${result.source || 'local'}`);
      }
      updateResults(`âœ… æ‰¹é‡æµ‹è¯•å®Œæˆ\n\n${results.join('\n')}`);
    } catch (error) {
      updateResults(`âŒ æ‰¹é‡æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  }

  // æµ‹è¯•ç¼“å­˜
  function testCache() {
    const stats = {
      total: 15,
      valid: 12,
      expired: 3,
      sources: {
        local: 8,
        wikipedia: 4,
        investopedia: 3
      }
    };
    
    updateResults(`ğŸ’¾ ç¼“å­˜ç»Ÿè®¡\n\næ€»ç¼“å­˜é¡¹: ${stats.total}\næœ‰æ•ˆç¼“å­˜: ${stats.valid}\nè¿‡æœŸç¼“å­˜: ${stats.expired}\næ¥æºåˆ†å¸ƒ:\n${Object.entries(stats.sources).map(([k, v]) => `  ${k}: ${v}`).join('\n')}`);
  }

  // æ¨¡æ‹ŸAPIè°ƒç”¨
  async function simulateAPICall(term) {
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
    
    const mockData = {
      'Bitcoin': {
        term: 'Bitcoin',
        fullName: 'Bitcoin',
        description: 'ç¬¬ä¸€ä¸ªå»ä¸­å¿ƒåŒ–åŠ å¯†è´§å¸ï¼Œç”±ä¸­æœ¬èªåœ¨2009å¹´åˆ›å»º',
        category: 'åŠ å¯†è´§å¸',
        example: 'æ¯”ç‰¹å¸æ€»ä¾›åº”é‡2100ä¸‡æšï¼Œé€šè¿‡æŒ–çŸ¿äº§ç”Ÿ',
        source: 'wikipedia'
      },
      'NASDAQ': {
        term: 'NASDAQ',
        fullName: 'NASDAQ',
        description: 'çº³æ–¯è¾¾å…‹è¯åˆ¸äº¤æ˜“æ‰€ï¼Œä¸»è¦äº¤æ˜“ç§‘æŠ€è‚¡',
        category: 'äº¤æ˜“æ‰€',
        example: 'è‹¹æœã€å¾®è½¯ã€è°·æ­Œç­‰ç§‘æŠ€å·¨å¤´åœ¨çº³æ–¯è¾¾å…‹ä¸Šå¸‚',
        source: 'wikipedia'
      },
      'PE': {
        term: 'PE',
        fullName: 'Price-to-Earnings Ratio',
        description: 'å¸‚ç›ˆç‡ï¼Œè‚¡ä»·ä¸æ¯è‚¡æ”¶ç›Šçš„æ¯”ç‡ï¼Œè¡¡é‡è‚¡ç¥¨ä¼°å€¼æ°´å¹³',
        category: 'ä¼°å€¼æŒ‡æ ‡',
        example: 'PE = è‚¡ä»· / æ¯è‚¡æ”¶ç›Šï¼Œé€šå¸¸15-25å€ä¸ºåˆç†åŒºé—´',
        source: 'local'
      },
      'ROE': {
        term: 'ROE',
        fullName: 'Return on Equity',
        description: 'å‡€èµ„äº§æ”¶ç›Šç‡ï¼Œè¡¡é‡å…¬å¸åˆ©ç”¨è‚¡ä¸œæŠ•èµ„åˆ›é€ åˆ©æ¶¦çš„æ•ˆç‡',
        category: 'è´¢åŠ¡æŒ‡æ ‡',
        example: 'ROE = å‡€åˆ©æ¶¦ / è‚¡ä¸œæƒç›Šï¼Œé€šå¸¸>15%ä¸ºä¼˜ç§€',
        source: 'local'
      },
      'ETF': {
        term: 'ETF',
        fullName: 'Exchange-Traded Fund',
        description: 'äº¤æ˜“æ‰€äº¤æ˜“åŸºé‡‘ï¼Œè·Ÿè¸ªç‰¹å®šæŒ‡æ•°æˆ–èµ„äº§',
        category: 'æŠ•èµ„äº§å“',
        example: 'SPYè·Ÿè¸ªæ ‡æ™®500æŒ‡æ•°ï¼ŒQQQè·Ÿè¸ªçº³æ–¯è¾¾å…‹100',
        source: 'local'
      }
    };
    
    const result = mockData[term];
    if (!result) {
      throw new Error(`æœªæ‰¾åˆ°æœ¯è¯­ "${term}" çš„å®šä¹‰`);
    }
    
    return result;
  }

  // æ›´æ–°ç»“æœæ˜¾ç¤º
  function updateResults(message) {
    document.getElementById('results').textContent = message;
  }
</script> 
 